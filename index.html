<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å›½æ€ Lite - å¢å¼ºç‰ˆ</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --modal-bg: rgba(0, 0, 0, 0.9);
            --lord-color: #f1c40f;
            --loyal-color: #e67e22;
            --rebel-color: #2ecc71;
            --traitor-color: #9b59b6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- é¡¶éƒ¨æ ï¼šå¸®åŠ©æŒ‰é’® --- */
        #top-bar {
            height: 30px;
            display: flex;
            justify-content: flex-end;
            padding: 0 10px;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }
        #btn-help {
            background: none; border: 1px solid #bdc3c7; color: #bdc3c7;
            border-radius: 50%; width: 24px; height: 24px; font-size: 14px;
            cursor: pointer;
        }

        /* --- æ•Œæ–¹åŒºåŸŸ --- */
        #enemy-zone {
            flex: 0 0 26%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #444;
        }

        .enemy-card {
            width: 30%;
            height: 100%;
            background: #34495e;
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.2s;
            overflow: hidden;
        }

        .enemy-card.active-turn { border-color: #f1c40f; box-shadow: 0 0 12px #f1c40f; transform: scale(1.02); z-index: 2; }
        .enemy-card.dead { opacity: 0.5; filter: grayscale(100%); }
        .enemy-card.targetable { border-color: #e74c3c; box-shadow: 0 0 15px #e74c3c; animation: pulse 0.8s infinite; }

        /* å¤´åƒæ¨¡æ‹Ÿ */
        .avatar-img {
            width: 100%; height: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; background: #2c3e50;
            border-bottom: 1px solid #555;
        }

        .role-badge { 
            position: absolute; top: 2px; right: 2px;
            font-size: 10px; padding: 2px 5px; border-radius: 4px; 
            background: #7f8c8d; color: white; z-index: 1;
        }
        .role-lord { background: var(--lord-color); color: black; }
        .role-loyal { background: var(--loyal-color); }
        .role-rebel { background: var(--rebel-color); }
        .role-traitor { background: var(--traitor-color); }

        .info-block { width: 100%; padding: 2px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-around; }
        .general-name { font-weight: bold; font-size: 13px; }
        .skill-tag { font-size: 10px; color: #3498db; background: rgba(52, 152, 219, 0.1); padding: 1px 4px; border-radius: 3px; display: inline-block; }

        /* --- æ—¥å¿—åŒºåŸŸ --- */
        #log-zone {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            padding: 10px;
            font-size: 13px;
            border-bottom: 1px solid #555;
        }
        .log-line { margin-bottom: 4px; line-height: 1.4; }
        .log-turn { color: #f1c40f; border-top: 1px dashed #555; margin-top: 6px; padding-top: 4px; }
        .log-damage { color: #e74c3c; font-weight: bold; }
        .log-skill { color: #3498db; font-weight: bold; }

        /* --- ç©å®¶åŒºåŸŸ --- */
        #player-zone {
            flex: 0 0 42%;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.2);
            padding: 5px;
        }

        #player-status {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; height: 30px;
        }
        .my-avatar-small { font-size: 20px; margin-right: 5px; }
        
        .hp-bar { display: flex; gap: 3px; }
        .hp-point { width: 12px; height: 12px; border-radius: 50%; background: #2ecc71; border: 1px solid #fff; box-shadow: 0 0 2px black; }
        .hp-lost { background: #555; border-color: #777; }

        /* æ‰‹ç‰Œ */
        #hand-scroll-container {
            flex: 1;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 5px;
            -webkit-overflow-scrolling: touch;
            display: flex; align-items: center;
        }

        .card {
            display: inline-flex; flex-direction: column; justify-content: center; align-items: center;
            width: 68px; height: 98px;
            background: #ecf0f1; border-radius: 6px;
            margin-right: 8px; flex-shrink: 0;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            color: #333; font-weight: bold; border-bottom: 4px solid #bdc3c7;
        }
        .card.selected { transform: translateY(-15px); border: 2px solid #e74c3c; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }

        /* å¡ç‰Œé¢œè‰²å®šä¹‰ */
        .card[data-type="æ€"] { color: #c0392b; border-bottom-color: #c0392b; }
        .card[data-type="é—ª"] { color: #2980b9; border-bottom-color: #2980b9; }
        .card[data-type="æ¡ƒ"] { color: #e91e63; border-bottom-color: #e91e63; }
        .card[data-type="ä¸‡ç®­"] { color: #8e44ad; border-bottom-color: #8e44ad; }
        .card[data-type="å—è›®"] { color: #d35400; border-bottom-color: #d35400; }
        .card[data-type="æ— ä¸­"] { color: #27ae60; border-bottom-color: #27ae60; }

        .card-icon { font-size: 26px; margin-bottom: 5px; }
        .card-text { font-size: 14px; }

        /* æŒ‰é’® */
        #controls { height: 45px; display: flex; gap: 10px; padding: 0 5px 5px 5px; }
        button {
            flex: 1; border: none; border-radius: 5px;
            font-size: 15px; font-weight: bold; color: white;
            background: #7f8c8d; transition: background 0.2s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.3; }
        #btn-confirm { background: #e67e22; }
        #btn-end { background: #27ae60; }

        /* --- å¼¹çª— (ç»“ç®— & å¸®åŠ©) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
            padding: 20px;
        }
        
        /* å¸®åŠ©å¼¹çª—å†…å®¹ */
        #help-content {
            background: #ecf0f1; color: #333;
            width: 90%; max-height: 80%;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        #help-content h3 { border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 20px; color: #2c3e50; }
        #help-content ul { padding-left: 20px; }
        #help-content li { margin-bottom: 5px; }
        .close-btn { margin-top: 15px; padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; font-size: 16px; }

        /* ç»“ç®—æ–‡å­— */
        #game-result-title { font-size: 32px; margin-bottom: 30px; text-align: center; font-weight: bold; }
        .win { color: #f1c40f; }
        .lose { color: #e74c3c; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="top-bar">
        <button id="btn-help" onclick="showHelp()">?</button>
    </div>

    <!-- é¡¶éƒ¨ï¼š3ä¸ªAI -->
    <div id="enemy-zone"></div>

    <!-- ä¸­é—´ï¼šæ—¥å¿— -->
    <div id="log-zone">
        <div class="log-line">ä¸‰å›½æ€ Lite å¢å¼ºç‰ˆ - æ¸¸æˆå¼€å§‹</div>
    </div>

    <!-- åº•éƒ¨ï¼šç©å®¶ -->
    <div id="player-zone">
        <div id="player-status">
            <div style="display:flex; align-items:center;">
                <span class="my-avatar-small">ğŸ‘‘</span>
                <span style="color:#f1c40f; font-weight:bold;">ä¸»å…¬ (æ›¹æ“)</span>
            </div>
            <div class="hp-bar" id="my-hp-bar"></div>
        </div>
        
        <div id="hand-scroll-container"></div>

        <div id="controls">
            <button id="btn-confirm" onclick="confirmAction()" disabled>å‡ºç‰Œ</button>
            <button id="btn-cancel" onclick="cancelAction()" disabled>å–æ¶ˆ</button>
            <button id="btn-end" onclick="endTurn()" disabled>ç»“æŸ</button>
        </div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div id="result-overlay" class="overlay">
        <h1 id="game-result-title"></h1>
        <button class="close-btn" onclick="location.reload()">å†æ¥ä¸€å±€</button>
    </div>

    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="help-overlay" class="overlay" style="align-items: center;">
        <div id="help-content">
            <h2 style="margin-top:0; text-align:center;">æ¸¸æˆè¯´æ˜ä¹¦</h2>
            
            <h3>ğŸ¯ èƒœåˆ©æ¡ä»¶</h3>
            <ul>
                <li><b>ä¸»å…¬ (ä½ )</b>ï¼šæ¶ˆç­æ‰€æœ‰ã€åè´¼ã€‘å’Œã€å†…å¥¸ã€‘ã€‚</li>
                <li><b>åè´¼</b>ï¼šæ€æ­»ã€ä¸»å…¬ã€‘ã€‚</li>
                <li><b>å¿ è‡£</b>ï¼šä¿æŠ¤ä¸»å…¬ï¼Œæ¶ˆç­åè´¼å’Œå†…å¥¸ã€‚</li>
                <li><b>å†…å¥¸</b>ï¼šå…ˆæ¶ˆç­å…¶ä»–äººï¼Œæœ€åå•æŒ‘æ€æ­»ä¸»å…¬ã€‚</li>
            </ul>

            <h3>ğŸƒ å¡ç‰Œè¯´æ˜</h3>
            <ul>
                <li><span style="color:#c0392b">âš”ï¸ æ€</span>ï¼šæ”»å‡»è·ç¦»ä¸º1çš„è§’è‰²ã€‚éœ€å‡ºã€é—ªã€‘æŠµæŒ¡ï¼Œå¦åˆ™æ‰£1è¡€ã€‚</li>
                <li><span style="color:#2980b9">ğŸ’¨ é—ª</span>ï¼šè¢«åŠ¨ç‰Œï¼ŒæŠµæŒ¡ã€æ€ã€‘æˆ–ã€ä¸‡ç®­é½å‘ã€‘ã€‚</li>
                <li><span style="color:#e91e63">ğŸ‘ æ¡ƒ</span>ï¼šå‡ºç‰Œé˜¶æ®µç»™è‡ªå·±å›1è¡€ï¼Œæˆ–æ¿’æ­»æ—¶æ•‘äººã€‚</li>
                <li><span style="color:#8e44ad">ğŸ¹ ä¸‡ç®­é½å‘</span>ï¼šå…¨åœºAOEã€‚é™¤ä½¿ç”¨è€…å¤–ï¼Œæ¯äººéœ€å‡ºã€é—ªã€‘ï¼Œå¦åˆ™æ‰£1è¡€ã€‚</li>
                <li><span style="color:#d35400">ğŸ˜ å—è›®å…¥ä¾µ</span>ï¼šå…¨åœºAOEã€‚é™¤ä½¿ç”¨è€…å¤–ï¼Œæ¯äººéœ€å‡ºã€æ€ã€‘ï¼Œå¦åˆ™æ‰£1è¡€ã€‚</li>
                <li><span style="color:#27ae60">ğŸ æ— ä¸­ç”Ÿæœ‰</span>ï¼šé”¦å›Šç‰Œï¼Œç«‹å³æ‘¸ 2 å¼ ç‰Œã€‚</li>
            </ul>

            <h3>ğŸ¦¸ æ­¦å°†æŠ€èƒ½</h3>
            <ul>
                <li><b>æ›¹æ“ (å¥¸é›„)</b>ï¼šå—åˆ°ä¼¤å®³åï¼Œç«‹å³æ‘¸ 1 å¼ ç‰Œã€‚</li>
                <li><b>å¼ é£ (å’†å“®)</b>ï¼šå‡ºã€æ€ã€‘æ²¡æœ‰æ¬¡æ•°é™åˆ¶ã€‚</li>
                <li><b>éƒ­å˜‰ (é—è®¡)</b>ï¼šå—åˆ°ä¼¤å®³åï¼Œç«‹å³æ‘¸ 2 å¼ ç‰Œã€‚</li>
                <li><b>èµµäº‘ (é¾™èƒ†)</b>ï¼šé˜²å¾¡åŠ›è¾ƒå¼ºï¼ŒAIå‡ºé—ªæ¦‚ç‡æ›´é«˜ã€‚</li>
            </ul>
            
            <div style="text-align:center;">
                <button class="close-btn" onclick="hideHelp()">å…³é—­</button>
            </div>
        </div>
    </div>

<script>
    // --- æ¸¸æˆé…ç½® ---
    const GENERALS = [
        { name: 'æ›¹æ“', hp: 5, skill: 'å¥¸é›„', avatar: 'ğŸ‘‘', color: '#8e44ad' },
        { name: 'å¼ é£', hp: 4, skill: 'å’†å“®', avatar: 'ğŸ‘¹', color: '#2c3e50' },
        { name: 'éƒ­å˜‰', hp: 3, skill: 'é—è®¡', avatar: 'ğŸ”®', color: '#2980b9' },
        { name: 'èµµäº‘', hp: 4, skill: 'é¾™èƒ†', avatar: 'ğŸ›¡ï¸', color: '#95a5a6' }
    ];
    
    // å¢åŠ æ–°å¡ç‰Œï¼šå—è›®ã€æ— ä¸­
    const DECK_TEMPLATE = [
        ...Array(20).fill('æ€'),
        ...Array(10).fill('é—ª'),
        ...Array(8).fill('æ¡ƒ'),
        ...Array(2).fill('ä¸‡ç®­'),
        ...Array(2).fill('å—è›®'),
        ...Array(3).fill('æ— ä¸­')
    ];

    let players = [];
    let deck = [];
    let currentTurnIndex = 0;
    let selectedCardIndex = -1;
    let isTargetingMode = false;
    let gameActive = true;

    // --- åˆå§‹åŒ– ---
    function initGame() {
        deck = [...DECK_TEMPLATE];
        shuffle(deck);

        let aiRoles = ['åè´¼', 'å¿ è‡£', 'å†…å¥¸'];
        shuffle(aiRoles);
        let aiGenerals = GENERALS.slice(1);
        shuffle(aiGenerals);

        // ç©å®¶ (ID 0)
        players.push({
            id: 0, isUser: true, name: 'ä½ ', 
            role: 'ä¸»å…¬', general: GENERALS[0], 
            hp: GENERALS[0].hp, maxHp: GENERALS[0].hp, 
            hand: [], isDead: false, hasAttacked: false
        });

        // AI (ID 1, 2, 3)
        for(let i=0; i<3; i++) {
            players.push({
                id: i+1, isUser: false, name: `AI-${i+1}`,
                role: aiRoles[i], general: aiGenerals[i],
                hp: aiGenerals[i].hp, maxHp: aiGenerals[i].hp,
                hand: [], isDead: false, hasAttacked: false,
                identityKnown: false
            });
        }

        players.forEach(p => drawCards(p, 4));
        renderAll();
        log("æ¸¸æˆå¼€å§‹ï¼ç‚¹å‡»å³ä¸Šè§’ ? æŸ¥çœ‹è§„åˆ™ã€‚", "turn");
        startTurn(0);
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    function startTurn(playerIndex) {
        if (!gameActive) return;
        currentTurnIndex = playerIndex;
        const p = players[playerIndex];

        if (p.isDead) {
            nextTurn();
            return;
        }

        p.hasAttacked = false;
        renderAll(); 

        log(`--- ${p.name} (${p.general.name}) å›åˆ ---`, "turn");
        drawCards(p, 2);
        
        if (p.isUser) {
            updateHandUI();
            updateButtons();
        } else {
            updateButtons();
            setTimeout(() => aiAction(p), 800);
        }
    }

    function nextTurn() {
        checkWinCondition();
        if (!gameActive) return;
        let nextIndex = (currentTurnIndex + 1) % 4;
        startTurn(nextIndex);
    }

    // --- ç©å®¶äº¤äº’ ---
    function selectCard(index) {
        if (!players[0].isUser || currentTurnIndex !== 0) return;
        
        if (selectedCardIndex === index) {
            cancelAction();
        } else {
            selectedCardIndex = index;
            const card = players[0].hand[index];
            if (card === 'æ€') {
                isTargetingMode = true;
                log("è¯·ç‚¹å‡»ä¸Šæ–¹å¤´åƒé€‰æ‹©ç›®æ ‡...");
            } else {
                isTargetingMode = false;
            }
            updateHandUI();
            updateButtons();
            renderEnemies();
        }
    }

    function selectTargetPlayer(targetId) {
        if (!isTargetingMode || selectedCardIndex === -1) return;
        const target = players[targetId];
        if (target.isDead) return;

        const card = players[0].hand[selectedCardIndex];
        if (card === 'æ€') {
            if (players[0].hasAttacked && players[0].general.name !== 'å¼ é£') {
                log("æœ¬å›åˆå·²å‡ºè¿‡æ€ï¼");
                cancelAction();
                return;
            }
            useCard(players[0], selectedCardIndex, target);
            cancelAction();
        }
    }

    function confirmAction() {
        if (selectedCardIndex === -1) return;
        const card = players[0].hand[selectedCardIndex];
        if (card === 'æ¡ƒ') useCard(players[0], selectedCardIndex, players[0]);
        else if (card === 'ä¸‡ç®­' || card === 'å—è›®' || card === 'æ— ä¸­') useCard(players[0], selectedCardIndex, null);
        cancelAction();
    }

    function cancelAction() {
        selectedCardIndex = -1;
        isTargetingMode = false;
        updateHandUI();
        updateButtons();
        renderEnemies();
    }

    function endTurn() {
        if (currentTurnIndex !== 0) return;
        nextTurn();
    }

    // --- æˆ˜æ–—é€»è¾‘ ---
    function useCard(source, cardIndex, target) {
        const card = source.hand[cardIndex];
        source.hand.splice(cardIndex, 1);

        if (card === 'æ€') {
            log(`${source.name} å¯¹ ${target.name} å‡ºã€æ€ã€‘`);
            source.hasAttacked = true;
            resolveAttack(source, target, 'sha');
        } 
        else if (card === 'æ¡ƒ') {
            if (target.hp < target.maxHp) {
                target.hp++;
                log(`${source.name} åƒã€æ¡ƒã€‘å›è¡€`, "skill");
            } else {
                log(`${source.name} æ»¡è¡€åƒæ¡ƒ(æ— æ•ˆ)`);
            }
        }
        else if (card === 'ä¸‡ç®­') {
            log(`${source.name} é‡Šæ”¾ã€ä¸‡ç®­é½å‘ã€‘ï¼`, "skill");
            players.forEach(p => {
                if (p !== source && !p.isDead) resolveAttack(source, p, 'wanjian');
            });
        }
        else if (card === 'å—è›®') {
            log(`${source.name} é‡Šæ”¾ã€å—è›®å…¥ä¾µã€‘ï¼`, "skill");
            players.forEach(p => {
                if (p !== source && !p.isDead) resolveAttack(source, p, 'nanman');
            });
        }
        else if (card === 'æ— ä¸­') {
            log(`${source.name} ä½¿ç”¨ã€æ— ä¸­ç”Ÿæœ‰ã€‘ï¼Œæ‘¸2ç‰Œ`, "skill");
            drawCards(source, 2);
        }

        renderAll();
    }

    // attackType: 'sha' (æ™®é€šæ€), 'wanjian' (éœ€é—ª), 'nanman' (éœ€æ€)
    function resolveAttack(source, target, attackType) {
        let defendCard = 'é—ª';
        if (attackType === 'nanman') defendCard = 'æ€';

        const cardIndex = target.hand.indexOf(defendCard);
        
        if (cardIndex !== -1) {
            target.hand.splice(cardIndex, 1);
            log(`${target.name} æ‰“å‡ºã€${defendCard}ã€‘ï¼ŒæŠµæ¶ˆä¼¤å®³`, "skill");
        } else {
            target.hp--;
            log(`${target.name} å—åˆ°ä¼¤å®³`, "damage");
            triggerDamageSkill(target);
            
            if (target.hp <= 0) {
                const taoIndex = target.hand.indexOf('æ¡ƒ');
                if (taoIndex !== -1) {
                    target.hand.splice(taoIndex, 1);
                    target.hp++;
                    log(`${target.name} æ¿’æ­»åƒã€æ¡ƒã€‘å¤æ´»`, "skill");
                } else {
                    handleDeath(source, target);
                }
            }
        }
    }

    function triggerDamageSkill(player) {
        if (player.isDead) return;
        if (player.general.name === 'æ›¹æ“') {
            log(`ã€å¥¸é›„ã€‘${player.name}æ‘¸1ç‰Œ`, "skill");
            drawCards(player, 1);
        } else if (player.general.name === 'éƒ­å˜‰') {
            log(`ã€é—è®¡ã€‘${player.name}æ‘¸2ç‰Œ`, "skill");
            drawCards(player, 2);
        }
    }

    function handleDeath(killer, deadPlayer) {
        deadPlayer.isDead = true;
        deadPlayer.identityKnown = true;
        log(`${deadPlayer.name} é˜µäº¡! èº«ä»½:[${deadPlayer.role}]`, "damage");
        
        if (deadPlayer.role === 'åè´¼') {
            log("å‡»æ€åè´¼ï¼Œæ‘¸3å¼ ", "skill");
            drawCards(killer, 3);
        } else if (deadPlayer.role === 'å¿ è‡£' && killer.role === 'ä¸»å…¬') {
            log("ä¸»å…¬æ€å¿ è‡£ï¼Œå¼ƒå…‰æ‰‹ç‰Œ", "damage");
            killer.hand = [];
        }
        checkWinCondition();
    }

    // --- AI ---
    function aiAction(ai) {
        if (ai.isDead || !gameActive) return;

        // 1. æ— ä¸­ç”Ÿæœ‰ (ä¼˜å…ˆ)
        if (ai.hand.includes('æ— ä¸­')) {
            useCard(ai, ai.hand.indexOf('æ— ä¸­'), null);
            if (!gameActive) return;
        }

        // 2. åƒæ¡ƒ
        while (ai.hp < ai.maxHp && ai.hand.includes('æ¡ƒ')) {
            useCard(ai, ai.hand.indexOf('æ¡ƒ'), ai);
        }

        // 3. AOE (ä¸‡ç®­/å—è›®)
        if (ai.hand.includes('ä¸‡ç®­')) {
            useCard(ai, ai.hand.indexOf('ä¸‡ç®­'), null);
            if (!gameActive) return;
        }
        if (ai.hand.includes('å—è›®')) {
            useCard(ai, ai.hand.indexOf('å—è›®'), null);
            if (!gameActive) return;
        }

        // 4. æ€
        let target = null;
        const alive = players.filter(p => !p.isDead && p !== ai);
        
        if (ai.role === 'åè´¼') target = players[0];
        else if (ai.role === 'å¿ è‡£') {
            const enemies = alive.filter(p => p.role !== 'ä¸»å…¬');
            if (enemies.length) target = enemies[Math.floor(Math.random()*enemies.length)];
        } else {
            target = alive[Math.floor(Math.random()*alive.length)];
        }

        if (target && !target.isDead && ai.hand.includes('æ€')) {
            if (!ai.hasAttacked || ai.general.name === 'å¼ é£') {
                useCard(ai, ai.hand.indexOf('æ€'), target);
            }
        }

        setTimeout(nextTurn, 800);
    }

    // --- è¾…åŠ© ---
    function drawCards(p, n) {
        for(let i=0; i<n; i++) {
            if (deck.length===0) { deck=[...DECK_TEMPLATE]; shuffle(deck); }
            p.hand.push(deck.pop());
        }
    }
    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }
    function checkWinCondition() {
        const lord = players[0];
        const rebels = players.filter(p => p.role === 'åè´¼' && !p.isDead);
        const traitor = players.filter(p => p.role === 'å†…å¥¸' && !p.isDead);
        if (lord.isDead) gameOver(false, "ä¸»å…¬é˜µäº¡ï¼Œå¤±è´¥ï¼");
        else if (rebels.length === 0 && traitor.length === 0) gameOver(true, "é€†è´¼å…¨ç­ï¼Œèƒœåˆ©ï¼");
    }
    function gameOver(win, msg) {
        gameActive = false;
        const t = document.getElementById('game-result-title');
        t.innerText = msg;
        t.className = win ? 'win' : 'lose';
        document.getElementById('result-overlay').style.display = 'flex';
    }
    function log(msg, type="") {
        const box = document.getElementById('log-zone');
        const div = document.createElement('div');
        div.className = `log-line ${type === 'turn' ? 'log-turn' : (type === 'damage' ? 'log-damage' : (type === 'skill' ? 'log-skill' : ''))}`;
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- UI æ¸²æŸ“ ---
    function renderAll() {
        renderEnemies();
        renderPlayerStatus();
        updateHandUI();
    }

    function renderEnemies() {
        const container = document.getElementById('enemy-zone');
        container.innerHTML = '';
        
        for(let i=1; i<=3; i++) {
            const p = players[i];
            const div = document.createElement('div');
            
            let roleText = p.identityKnown ? p.role : "???";
            let roleClass = p.identityKnown ? (p.role === 'åè´¼' ? 'role-rebel' : (p.role === 'å¿ è‡£' ? 'role-loyal' : 'role-traitor')) : '';
            
            let classes = `enemy-card ${p.isDead ? 'dead' : ''} ${currentTurnIndex === i ? 'active-turn' : ''}`;
            if (isTargetingMode && !p.isDead) classes += ' targetable';

            div.className = classes;
            div.onclick = () => selectTargetPlayer(i);
            
            div.innerHTML = `
                <div class="role-badge ${roleClass}">${roleText}</div>
                <div class="avatar-img" style="background:${p.general.color}">${p.general.avatar}</div>
                <div class="info-block">
                    <div class="general-name">${p.general.name}</div>
                    <div class="skill-tag">${p.general.skill}</div>
                    <div class="hp-bar" style="justify-content:center;">${getHpHtml(p.hp, p.maxHp)}</div>
                    <div style="font-size:10px; color:#bdc3c7;">æ‰‹ç‰Œ: ${p.hand.length}</div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    function renderPlayerStatus() {
        const p = players[0];
        document.getElementById('my-hp-bar').innerHTML = getHpHtml(p.hp, p.maxHp);
    }

    function getHpHtml(hp, max) {
        let html = '';
        for(let i=0; i<max; i++) {
            html += `<div class="hp-point ${i < hp ? '' : 'hp-lost'}"></div>`;
        }
        return html;
    }

    function updateHandUI() {
        const container = document.getElementById('hand-scroll-container');
        container.innerHTML = '';
        const p = players[0];

        p.hand.forEach((card, idx) => {
            const el = document.createElement('div');
            el.className = `card ${idx === selectedCardIndex ? 'selected' : ''}`;
            el.setAttribute('data-type', card);
            el.onclick = () => selectCard(idx);
            
            let icon = '';
            if(card==='æ€') icon='âš”ï¸';
            if(card==='é—ª') icon='ğŸ’¨';
            if(card==='æ¡ƒ') icon='ğŸ‘';
            if(card==='ä¸‡ç®­') icon='ğŸ¹';
            if(card==='å—è›®') icon='ğŸ˜';
            if(card==='æ— ä¸­') icon='ğŸ';

            el.innerHTML = `<div class="card-icon">${icon}</div><div class="card-text">${card}</div>`;
            container.appendChild(el);
        });
    }

    function updateButtons() {
        const isMyTurn = currentTurnIndex === 0;
        const hasSelected = selectedCardIndex !== -1;
        const card = hasSelected ? players[0].hand[selectedCardIndex] : null;

        document.getElementById('btn-end').disabled = !isMyTurn;
        document.getElementById('btn-cancel').disabled = !hasSelected;
        
        let canConfirm = false;
        if (isMyTurn && hasSelected) {
            if (card === 'æ¡ƒ' && players[0].hp < players[0].maxHp) canConfirm = true;
            if (['ä¸‡ç®­', 'å—è›®', 'æ— ä¸­'].includes(card)) canConfirm = true;
        }
        document.getElementById('btn-confirm').disabled = !canConfirm;
    }

    // å¸®åŠ©å¼¹çª—æ§åˆ¶
    function showHelp() { document.getElementById('help-overlay').style.display = 'flex'; }
    function hideHelp() { document.getElementById('help-overlay').style.display = 'none'; }

    initGame();
</script>
</body>
</html>
