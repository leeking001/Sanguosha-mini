<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å›½æ€ Lite - ä¾ ä¹‰æ±Ÿæ¹–ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: rgba(44, 62, 80, 0.9);
            --paper-color: #f3e5ab;
            --gold: #d4af37;
            --red: #c0392b;
            --blue: #2980b9;
            --green: #27ae60;
            --text-color: #ecf0f1;
            --font-main: "Kaiti", "STKaiti", "KaiTi", "Georgia", serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: var(--bg-color);
            background-image: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            color: var(--text-color);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- é¡¶éƒ¨æ  --- */
        #top-bar {
            height: 45px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--gold);
            z-index: 10;
        }
        .game-title { font-size: 18px; font-weight: bold; color: var(--gold); letter-spacing: 2px; text-shadow: 0 0 5px #000; }
        .top-btns { display: flex; gap: 10px; }
        .icon-btn { 
            width: 32px; height: 32px; border-radius: 50%; font-size: 16px; 
            display: flex; justify-content: center; align-items: center; 
            background: #34495e; border: 1px solid var(--gold); color: var(--gold);
        }

        /* --- æˆ˜åœºåŒºåŸŸ --- */
        #enemy-zone {
            flex: 0 0 28%; display: flex; justify-content: space-around; align-items: center;
            padding: 10px 5px; border-bottom: 1px solid #555;
        }

        .enemy-card {
            width: 30%; height: 100%;
            background: #2c3e50; border: 2px solid #555; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center;
            position: relative; transition: all 0.3s;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .enemy-card.active-turn { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.05); z-index: 2; }
        .enemy-card.dead { opacity: 0.4; filter: grayscale(100%); border-style: dashed; }
        .enemy-card.targetable { border-color: var(--red); box-shadow: 0 0 15px var(--red); animation: shake 0.5s infinite; }
        .enemy-card.lord-border { border: 2px solid #f1c40f; }

        .avatar-frame {
            width: 100%; height: 55%;
            display: flex; justify-content: center; align-items: center;
            font-size: 36px; background: #34495e; border-bottom: 1px solid #555;
            position: relative;
        }
        .role-badge { 
            position: absolute; top: 2px; right: 2px; font-size: 10px; padding: 2px 5px; 
            background: #000; border: 1px solid #777; color: #fff; border-radius: 3px;
        }

        .info-block { width: 100%; flex: 1; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 2px; }
        .general-name { font-size: 14px; font-weight: bold; color: var(--paper-color); text-shadow: 1px 1px 2px black; }
        
        /* --- æ—¥å¿—åŒºåŸŸ --- */
        #log-zone {
            flex: 1; background: rgba(0, 0, 0, 0.4);
            overflow-y: auto; padding: 10px 15px;
            font-size: 14px; color: #bdc3c7;
            border-bottom: 1px solid #555;
            font-family: "Courier New", Courier, monospace;
        }
        .log-line { margin-bottom: 5px; line-height: 1.4; }
        .log-turn { color: var(--gold); margin-top: 8px; border-top: 1px dashed #555; padding-top: 4px; font-weight: bold; }
        .log-damage { color: var(--red); font-weight: bold; }
        .log-skill { color: var(--blue); }
        .log-system { color: #27ae60; font-style: italic; }

        /* --- ç©å®¶åŒºåŸŸ --- */
        #player-zone {
            flex: 0 0 40%; display: flex; flex-direction: column;
            background: rgba(20, 20, 20, 0.95); padding: 5px;
            border-top: 2px solid var(--gold);
        }

        #player-status { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; height: 40px; }
        .my-info { display: flex; align-items: center; gap: 10px; }
        .my-role { font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .role-lord { background: #f1c40f; color: #000; }
        .role-loyal { background: #e67e22; color: #fff; }
        .role-rebel { background: #2ecc71; color: #fff; }
        .role-spy { background: #9b59b6; color: #fff; }

        .hp-bar { display: flex; gap: 3px; }
        .hp-point { 
            width: 14px; height: 14px; border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #2ecc71, #27ae60); 
            border: 1px solid #fff; box-shadow: 0 0 3px black; 
        }
        .hp-lost { background: #444; border-color: #666; }

        /* æ‰‹ç‰Œ */
        #hand-scroll-container {
            flex: 1; overflow-x: auto; white-space: nowrap;
            padding: 10px 5px; display: flex; align-items: center;
        }

        .card {
            display: inline-flex; flex-direction: column; justify-content: center; align-items: center;
            width: 75px; height: 105px;
            background: var(--paper-color); 
            border-radius: 5px; margin-right: 8px; flex-shrink: 0;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            transition: transform 0.2s;
            color: #333; font-weight: bold; border: 1px solid #d7ccc8;
        }
        .card.selected { transform: translateY(-20px); border: 2px solid var(--red); box-shadow: 0 0 15px var(--red); }

        .card[data-type="æ€"] { color: #8b0000; }
        .card[data-type="é—ª"] { color: #154360; }
        .card[data-type="æ¡ƒ"] { color: #d81b60; }
        .card[data-type="é…’"] { color: #a04000; }
        .card[data-type="ä¸‡ç®­"], .card[data-type="å—è›®"] { color: #6c3483; }
        .card[data-type="æ— ä¸­"], .card[data-type="äº”è°·"] { color: #1e8449; }
        .card[data-type="é¡ºæ‰‹"], .card[data-type="æ‹†æ¡¥"] { color: #117864; }
        .card[data-type="å†³æ–—"] { color: #000; border: 1px solid #000; }
        .card[data-type="ç«æ”»"] { color: #e74c3c; }

        .card-icon { font-size: 30px; margin-bottom: 5px; }
        .card-text { font-family: var(--font-main); font-size: 16px; }

        /* åº•éƒ¨æŒ‰é’® */
        #controls { height: 50px; display: flex; gap: 10px; padding: 5px; }
        .btn-action { flex: 1; font-size: 16px; font-weight: bold; border-radius: 4px; color: white; border: 1px solid rgba(255,255,255,0.2); }
        #btn-confirm { background: #d35400; }
        #btn-end { background: #27ae60; }
        #btn-cancel { background: #7f8c8d; }

        /* --- å¼¹çª— --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }

        /* é€‰å°†/é€‰èº«ä»½ç•Œé¢ */
        .select-container { width: 90%; max-width: 600px; text-align: center; }
        .select-title { font-size: 24px; color: var(--gold); margin-bottom: 20px; }
        
        .role-options, .hero-options { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        
        .role-card {
            width: 80px; height: 100px; background: #34495e; border: 2px solid #7f8c8d;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            cursor: pointer; color: white; border-radius: 8px;
        }
        .role-card:hover { border-color: var(--gold); background: #2c3e50; }

        .hero-option {
            width: 100px; height: 140px;
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .hero-option:hover { transform: scale(1.1); border-color: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .hero-avatar { font-size: 40px; margin-bottom: 10px; }
        .hero-name { font-weight: bold; color: white; }
        .hero-skill { font-size: 12px; color: #bdc3c7; margin-top: 5px; }

        /* ç»“ç®—ç•Œé¢ */
        #result-title { font-size: 40px; margin-bottom: 20px; font-family: var(--font-main); }
        .win { color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .lose { color: var(--red); text-shadow: 0 0 10px var(--red); }

        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }

    </style>
</head>
<body>

    <!-- é¡¶éƒ¨æ  -->
    <div id="top-bar">
        <div class="game-title">ä¸‰å›½æ€Â·ä¾ ä¹‰ç¯‡</div>
        <div class="top-btns">
            <button class="icon-btn" onclick="toggleBGM()" id="btn-bgm">ğŸµ</button>
            <button class="icon-btn" onclick="toggleSound()" id="btn-sound">ğŸ”Š</button>
            <button class="icon-btn" onclick="showHelp()">?</button>
        </div>
    </div>

    <!-- æ•Œæ–¹åŒºåŸŸ -->
    <div id="enemy-zone"></div>

    <!-- æ—¥å¿— -->
    <div id="log-zone">
        <div class="log-line">æ¬¢è¿æ¥åˆ°ä¾ ä¹‰æ±Ÿæ¹–...</div>
    </div>

    <!-- ç©å®¶åŒºåŸŸ -->
    <div id="player-zone">
        <div id="player-status">
            <div class="my-info">
                <span id="my-role-badge" class="my-role"></span>
                <span id="my-avatar" style="font-size:24px;"></span>
                <span id="my-name" class="my-name"></span>
                <span id="my-skill" style="font-size:12px; color:#bdc3c7;"></span>
            </div>
            <div class="hp-bar" id="my-hp-bar"></div>
        </div>
        
        <div id="hand-scroll-container"></div>

        <div id="controls">
            <button id="btn-confirm" class="btn-action" onclick="confirmAction()" disabled>å‡ºç‰Œ</button>
            <button id="btn-cancel" class="btn-action" onclick="cancelAction()" disabled>å–æ¶ˆ</button>
            <button id="btn-end" class="btn-action" onclick="endTurn()" disabled>ç»“æŸ</button>
        </div>
    </div>

    <!-- æµç¨‹å¼¹çª— -->
    <div id="setup-screen" class="overlay" style="display:flex;">
        <!-- æ­¥éª¤1ï¼šé€‰èº«ä»½ -->
        <div id="step-role" class="select-container">
            <div class="select-title">ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä½ çš„èº«ä»½</div>
            <div class="role-options">
                <div class="role-card" onclick="selectRole('ä¸»å…¬')" style="border-color:#f1c40f">ä¸»å…¬</div>
                <div class="role-card" onclick="selectRole('å¿ è‡£')" style="border-color:#e67e22">å¿ è‡£</div>
                <div class="role-card" onclick="selectRole('åè´¼')" style="border-color:#2ecc71">åè´¼</div>
                <div class="role-card" onclick="selectRole('å†…å¥¸')" style="border-color:#9b59b6">å†…å¥¸</div>
            </div>
        </div>
        <!-- æ­¥éª¤2ï¼šé€‰æ­¦å°† -->
        <div id="step-hero" class="select-container" style="display:none;">
            <div class="select-title">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä½ çš„æ­¦å°†</div>
            <div class="hero-options" id="hero-selection"></div>
        </div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div id="result-overlay" class="overlay">
        <div id="result-title"></div>
        <button class="btn-action" style="flex:0; padding:10px 30px;" onclick="location.reload()">å†æˆ˜æ±Ÿæ¹–</button>
    </div>

    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="help-overlay" class="overlay" onclick="this.style.display='none'">
        <div style="background:var(--paper-color); color:#333; padding:20px; border-radius:5px; max-width:80%; max-height:80%; overflow-y:auto;">
            <h2 style="text-align:center; margin-top:0;">æ±Ÿæ¹–è§„çŸ©</h2>
            <p><b>èƒœåˆ©æ¡ä»¶</b>ï¼š<br>
            ğŸ‘‘ ä¸»å…¬ï¼šæ¶ˆç­åè´¼å’Œå†…å¥¸ã€‚<br>
            ğŸ›¡ï¸ å¿ è‡£ï¼šä¿æŠ¤ä¸»å…¬ï¼Œæ¶ˆç­åè´¼å†…å¥¸ã€‚<br>
            ğŸ—¡ï¸ åè´¼ï¼šå‡»æ€ä¸»å…¬ã€‚<br>
            ğŸ­ å†…å¥¸ï¼šå…ˆç­åè´¼å¿ è‡£ï¼Œæœ€åå•æŒ‘ä¸»å…¬ã€‚</p>
            <hr>
            <p><b>æ–°å¢å¡ç‰Œ</b>ï¼š<br>
            âš”ï¸ <b>å†³æ–—</b>ï¼šæŒ‡å®šä¸€åç›®æ ‡ï¼Œå¯¹æ–¹éœ€å‡ºã€æ€ã€‘ï¼Œå¦åˆ™å—1ç‚¹ä¼¤å®³ï¼›è‹¥å‡ºæ€ï¼Œåˆ™ä½ éœ€å‡ºã€æ€ã€‘ï¼Œå¾ªç¯ç›´åˆ°ä¸€æ–¹å—æŸã€‚<br>
            ğŸŒ¾ <b>äº”è°·</b>ï¼šå…¨åœºæ¯äººæ‘¸ä¸€å¼ ç‰Œã€‚<br>
            ğŸ”¥ <b>ç«æ”»</b>ï¼šå¼ƒç½®ä¸€å¼ æ‰‹ç‰Œï¼Œå¯¹ç›®æ ‡é€ æˆ1ç‚¹ä¼¤å®³ï¼ˆç›®æ ‡å¯å¼ƒç½®ä¸€å¼ ç‰ŒæŠµæ¶ˆï¼‰ã€‚</p>
            <p style="text-align:center; color:#7f8c8d;">(ç‚¹å‡»ä»»æ„å¤„å…³é—­)</p>
        </div>
    </div>

<script>
    // --- éŸ³æ•ˆä¸BGMç³»ç»Ÿ (Web Audio API) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;
    let bgmEnabled = false;
    let bgmOscillators = [];
    let bgmInterval;

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('btn-sound').innerText = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    }

    // BGM ç”Ÿæˆå™¨ï¼šäº”å£°éŸ³é˜¶å¤é£æ°›å›´
    function toggleBGM() {
        bgmEnabled = !bgmEnabled;
        document.getElementById('btn-bgm').innerText = bgmEnabled ? 'ğŸµ' : 'âœ–ï¸';
        if (bgmEnabled) startBGM();
        else stopBGM();
    }

    function startBGM() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        // ç®€å•çš„äº”å£°éŸ³é˜¶éšæœºç”Ÿæˆ
        const scale = [196.00, 220.00, 261.63, 293.66, 329.63, 392.00]; // G A C D E G
        
        function playNote() {
            if (!bgmEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const freq = scale[Math.floor(Math.random() * scale.length)] * (Math.random() > 0.8 ? 0.5 : 1);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            // æŸ”å’Œçš„åŒ…ç»œ
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 1); // æ·¡å…¥
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 4); // é•¿å°¾æ·¡å‡º
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 4);
        }
        
        // å¯åŠ¨èƒŒæ™¯ä½éŸ³ Drone
        const drone = audioCtx.createOscillator();
        const droneGain = audioCtx.createGain();
        drone.type = 'triangle';
        drone.frequency.value = 98.00; // Low G
        droneGain.gain.value = 0.02;
        drone.connect(droneGain);
        droneGain.connect(audioCtx.destination);
        drone.start();
        bgmOscillators.push(drone);

        playNote();
        bgmInterval = setInterval(playNote, 2500); // æ¯2.5ç§’å¼¹ä¸€ä¸ªéŸ³
    }

    function stopBGM() {
        clearInterval(bgmInterval);
        bgmOscillators.forEach(o => o.stop());
        bgmOscillators = [];
    }

    function playTone(freq, type, duration, vol=0.1) {
        if (!soundEnabled) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const SFX = {
        card: () => { 
            if (!soundEnabled) return;
            playTone(800, 'triangle', 0.05, 0.05);
        },
        attack: () => playTone(600, 'sawtooth', 0.1, 0.1),
        damage: () => playTone(100, 'square', 0.3, 0.2),
        heal: () => playTone(800, 'sine', 0.5, 0.1),
        aoe: () => { playTone(200, 'sawtooth', 0.4, 0.1); setTimeout(()=>playTone(150, 'sawtooth', 0.4, 0.1), 100); },
        duel: () => { playTone(400, 'square', 0.1); setTimeout(()=>playTone(400, 'square', 0.1), 150); },
        win: () => { playTone(400, 'triangle', 0.2); setTimeout(()=>playTone(600, 'triangle', 0.4), 200); },
        lose: () => { playTone(300, 'sawtooth', 0.5); setTimeout(()=>playTone(200, 'sawtooth', 0.5), 400); }
    };

    // --- æ¸¸æˆæ•°æ® ---
    const GENERALS_DATA = [
        { name: 'æ›¹æ“', hp: 5, skill: 'å¥¸é›„', desc: 'å—ä¼¤æ‘¸ç‰Œ', avatar: 'ğŸ‘‘', color: '#8e44ad' },
        { name: 'å¼ é£', hp: 4, skill: 'å’†å“®', desc: 'æ— é™å‡ºæ€', avatar: 'ğŸ‘¹', color: '#c0392b' },
        { name: 'éƒ­å˜‰', hp: 3, skill: 'é—è®¡', desc: 'å—ä¼¤æ‘¸2', avatar: 'ğŸ”®', color: '#2980b9' },
        { name: 'èµµäº‘', hp: 4, skill: 'é¾™èƒ†', desc: 'æ”»å®ˆå…¼å¤‡', avatar: 'ğŸ›¡ï¸', color: '#95a5a6' },
        { name: 'å•å¸ƒ', hp: 5, skill: 'æ— åŒ', desc: 'æ€éœ€2é—ª', avatar: 'ğŸ”¥', color: '#e74c3c' },
        { name: 'åä½—', hp: 3, skill: 'æ€¥æ•‘', desc: 'å›åˆå¤–å›è¡€', avatar: 'ğŸŒ¿', color: '#27ae60' },
        { name: 'åˆ˜å¤‡', hp: 4, skill: 'ä»å¾·', desc: 'å¼€å±€é¢å¤–æ‘¸ç‰Œ', avatar: 'ğŸ‰', color: '#2ecc71' },
        { name: 'å‘¨ç‘œ', hp: 4, skill: 'ä¸šç‚', desc: 'AOEåæ‘¸ç‰Œ', avatar: 'ğŸ”¥', color: '#e67e22' },
        { name: 'è®¸è¤š', hp: 4, skill: 'è£¸è¡£', desc: 'æ€æ›´éš¾é—ª', avatar: 'ğŸ›¡ï¸', color: '#7f8c8d' },
        { name: 'å­™å°šé¦™', hp: 4, skill: 'ç»“å§»', desc: 'è£…å¤‡å¤š', avatar: 'ğŸ€', color: '#e91e63' }
    ];

    // æ‰©å……ç‰Œå †
    const DECK_TEMPLATE = [
        ...Array(24).fill('æ€'), ...Array(12).fill('é—ª'), ...Array(8).fill('æ¡ƒ'), ...Array(4).fill('é…’'),
        ...Array(2).fill('ä¸‡ç®­'), ...Array(2).fill('å—è›®'), ...Array(3).fill('æ— ä¸­'),
        ...Array(3).fill('é¡ºæ‰‹'), ...Array(3).fill('æ‹†æ¡¥'),
        ...Array(3).fill('å†³æ–—'), ...Array(2).fill('äº”è°·'), ...Array(3).fill('ç«æ”»')
    ];

    let players = [];
    let deck = [];
    let currentTurnIndex = 0;
    let selectedCardIndex = -1;
    let isTargetingMode = false;
    let gameActive = false;
    let userRole = '';

    function requiresTarget(card) {
        return ['æ€', 'é¡ºæ‰‹', 'æ‹†æ¡¥', 'å†³æ–—', 'ç«æ”»'].includes(card);
    }

    // --- æ¸¸æˆåˆå§‹åŒ–æµç¨‹ ---
    
    function selectRole(role) {
        userRole = role;
        document.getElementById('step-role').style.display = 'none';
        showHeroSelection();
    }

    function showHeroSelection() {
        const container = document.getElementById('hero-selection');
        let pool = [...GENERALS_DATA];
        shuffle(pool);
        const options = pool.slice(0, 4);

        options.forEach(hero => {
            const el = document.createElement('div');
            el.className = 'hero-option';
            el.innerHTML = `
                <div class="hero-avatar" style="color:${hero.color}">${hero.avatar}</div>
                <div class="hero-name">${hero.name}</div>
                <div class="hero-skill">${hero.skill}</div>
            `;
            el.onclick = () => startGame(hero);
            container.appendChild(el);
        });
        document.getElementById('step-hero').style.display = 'block';
    }

    function startGame(selectedHero) {
        document.getElementById('setup-screen').style.display = 'none';
        gameActive = true;
        SFX.win();

        // 1. åˆå§‹åŒ–ç‰Œå †
        deck = [...DECK_TEMPLATE];
        shuffle(deck);

        // 2. è§’è‰²åˆ†é…é€»è¾‘
        // æ ‡å‡†å±€ï¼š1ä¸» 1å¿  1å 1å†…
        let roles = ['ä¸»å…¬', 'å¿ è‡£', 'åè´¼', 'å†…å¥¸'];
        // ç§»é™¤ç©å®¶é€‰çš„èº«ä»½
        const roleIdx = roles.indexOf(userRole);
        roles.splice(roleIdx, 1);
        shuffle(roles); // æ‰“ä¹±å‰©ä¸‹çš„ç»™AI

        // 3. æ­¦å°†åˆ†é…
        let aiPool = GENERALS_DATA.filter(g => g.name !== selectedHero.name);
        shuffle(aiPool);

        // 4. æ„å»ºç©å®¶ (ç©å®¶å›ºå®šåœ¨ç´¢å¼•0ï¼Œæ–¹ä¾¿UIï¼Œä½†è¡ŒåŠ¨é¡ºåºç”±ä¸»å…¬å†³å®š)
        players = [];
        
        // ç©å®¶ (Index 0)
        players.push({
            id: 0, isUser: true, role: userRole, general: selectedHero,
            hp: selectedHero.hp + (userRole==='ä¸»å…¬'?1:0), // ä¸»å…¬+1è¡€
            maxHp: selectedHero.hp + (userRole==='ä¸»å…¬'?1:0), 
            hand: [], isDead: false, hasAttacked: false, berserk: false,
            identityKnown: userRole === 'ä¸»å…¬' // ä¸»å…¬äº®èº«ä»½
        });

        // AI (Index 1-3)
        for(let i=0; i<3; i++) {
            let r = roles[i];
            let g = aiPool[i];
            players.push({
                id: i+1, isUser: false, role: r, general: g,
                hp: g.hp + (r==='ä¸»å…¬'?1:0), 
                maxHp: g.hp + (r==='ä¸»å…¬'?1:0), 
                hand: [], isDead: false, hasAttacked: false, berserk: false,
                identityKnown: r === 'ä¸»å…¬'
            });
        }

        // 5. å‘ç‰Œ
        players.forEach(p => drawCards(p, 4));

        // 6. UIåˆå§‹åŒ–
        document.getElementById('my-avatar').innerText = selectedHero.avatar;
        document.getElementById('my-name').innerText = selectedHero.name;
        document.getElementById('my-skill').innerText = `[${selectedHero.skill}]`;
        const badge = document.getElementById('my-role-badge');
        badge.innerText = userRole;
        badge.className = `my-role role-${userRole==='ä¸»å…¬'?'lord':(userRole==='å¿ è‡£'?'loyal':(userRole==='åè´¼'?'rebel':'spy'))}`;
        
        renderAll();
        
        // 7. ç¡®å®šå…ˆæ‰‹ (ä¸»å…¬å…ˆæ‰‹)
        let lordIndex = players.findIndex(p => p.role === 'ä¸»å…¬');
        log(`æ±Ÿæ¹–é£èµ·äº‘æ¶Œï¼Œ${players[lordIndex].general.name} (ä¸»å…¬) ç‡å…ˆè¡ŒåŠ¨ï¼`, "system");
        startTurn(lordIndex);
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    function startTurn(idx) {
        if (!gameActive) return;
        currentTurnIndex = idx;
        const p = players[idx];

        if (p.isDead) { nextTurn(); return; }

        p.hasAttacked = false;
        p.berserk = false;
        
        // æ‘¸ç‰Œé˜¶æ®µ
        if (p.general.name === 'åˆ˜å¤‡') { log(`ã€ä»å¾·ã€‘${p.general.name} ä»å¿ƒæ˜­æ˜­ï¼Œé¢å¤–æ‘¸1ç‰Œ`, 'skill'); drawCards(p, 1); }
        renderAll();
        log(`--- ${p.general.name} (${p.identityKnown?p.role:'???'}) å›åˆ ---`, "turn");
        drawCards(p, 2);

        if (p.isUser) {
            updateHandUI();
            updateButtons();
        } else {
            updateButtons();
            setTimeout(() => aiAction(p), 1000);
        }
    }

    function nextTurn() {
        checkWin();
        if (!gameActive) return;
        startTurn((currentTurnIndex + 1) % 4);
    }

    // --- ç©å®¶æ“ä½œ ---
    function selectCard(idx) {
        if (!players[0].isUser || currentTurnIndex !== 0) return;
        SFX.card();
        if (selectedCardIndex === idx) {
            cancelAction();
        } else {
            selectedCardIndex = idx;
            const card = players[0].hand[idx];
            isTargetingMode = requiresTarget(card);
            if (isTargetingMode) log("è¯·ç‚¹å‡»ä¸Šæ–¹å¤´åƒé€‰æ‹©ç›®æ ‡");
            updateHandUI();
            updateButtons();
            renderEnemies();
        }
    }

    function selectTarget(id) {
        if (!isTargetingMode || selectedCardIndex === -1) return;
        const target = players[id];
        if (target.isDead) return;

        const p = players[0];
        const card = p.hand[selectedCardIndex];
        
        // ç›®æ ‡åˆæ³•æ€§æ£€æŸ¥
        if (card === 'æ€' && p.hasAttacked && p.general.name !== 'å¼ é£') {
            log("æœ¬å›åˆå·²å‡ºè¿‡æ€"); cancelAction(); return;
        }
        
        useCard(p, selectedCardIndex, target);
        cancelAction();
    }

    function confirmAction() {
        const p = players[0];
        const card = p.hand[selectedCardIndex];
        if (card === 'æ¡ƒ' || card === 'é…’') useCard(p, selectedCardIndex, p);
        else useCard(p, selectedCardIndex, null); // AOE or Draw
        cancelAction();
    }

    function cancelAction() {
        selectedCardIndex = -1; isTargetingMode = false;
        updateHandUI(); updateButtons(); renderEnemies();
    }

    function endTurn() { if (currentTurnIndex === 0) nextTurn(); }

    // --- å¡ç‰Œé€»è¾‘ ---
    function useCard(source, idx, target) {
        const card = source.hand[idx];
        source.hand.splice(idx, 1);
        SFX.card();

        if (card === 'æ€') {
            log(`${source.general.name} å¯¹ ${target.general.name} å‡ºã€æ€ã€‘`);
            SFX.attack();
            source.hasAttacked = true;
            resolveAttack(source, target, 'sha');
            if (source.berserk) { source.hasAttacked = false; source.berserk = false; log(`ã€é…’åŠ²ã€‘${source.general.name} ä»å¯å†å‡ºæ€`, 'skill'); }
        } 
        else if (card === 'æ¡ƒ') {
            if (target.hp < target.maxHp) {
                target.hp++;
                log(`${source.general.name} åƒã€æ¡ƒã€‘å›è¡€`, "skill");
                SFX.heal();
            }
        } 
        else if (card === 'é…’') {
            if (target.hp < target.maxHp) { target.hp++; log(`${source.general.name} é¥®ã€é…’ã€‘å›å¤ä½“åŠ›`, 'skill'); SFX.heal(); }
            source.berserk = true;
            log(`${source.general.name} é…’æ°”ä¸Šæ¶Œï¼Œæ€åŠ¿æ›´çŒ›`, 'skill');
        } 
        else if (card === 'ä¸‡ç®­' || card === 'å—è›®') {
            log(`${source.general.name} é‡Šæ”¾ã€${card}ã€‘`, "skill");
            SFX.aoe();
            players.forEach(p => {
                if (p !== source && !p.isDead) resolveAttack(source, p, card === 'ä¸‡ç®­' ? 'wanjian' : 'nanman');
            });
            if (source.general.name === 'å‘¨ç‘œ') { log(`ã€ä¸šç‚ã€‘${source.general.name} AOEåç¥é‡‡å¥•å¥•ï¼Œæ‘¸1ç‰Œ`, 'skill'); drawCards(source, 1); }
        } 
        else if (card === 'æ— ä¸­') {
            log(`${source.general.name} ã€æ— ä¸­ç”Ÿæœ‰ã€‘`, "skill");
            SFX.heal();
            drawCards(source, 2);
        } 
        else if (card === 'äº”è°·') {
            log(`${source.general.name} å¼€å¯ã€äº”è°·ä¸°ç™»ã€‘`, "skill");
            SFX.heal();
            players.forEach(p => { if(!p.isDead) drawCards(p, 1); });
            log("å…¨åœºå„æ‘¸ä¸€å¼ ç‰Œ", "system");
        }
        else if (card === 'é¡ºæ‰‹') {
            if (target.hand.length > 0) {
                const stealIdx = Math.floor(Math.random() * target.hand.length);
                const got = target.hand.splice(stealIdx, 1)[0];
                source.hand.push(got);
                log(`${source.general.name} ã€é¡ºæ‰‹ç‰µç¾Šã€‘è·å¾— ${target.general.name} ä¸€å¼ ç‰Œ`, 'skill');
            } else log(`${target.general.name} ç©ºæ‰‹ï¼Œé¡ºæ‰‹æ— åŠŸ`);
        } 
        else if (card === 'æ‹†æ¡¥') {
            if (target.hand.length > 0) {
                const discardIdx = Math.floor(Math.random() * target.hand.length);
                target.hand.splice(discardIdx, 1);
                log(`${source.general.name} ã€è¿‡æ²³æ‹†æ¡¥ã€‘å¼ƒç½® ${target.general.name} ä¸€å¼ ç‰Œ`, 'skill');
            } else log(`${target.general.name} ç©ºæ‰‹ï¼Œæ‹†æ¡¥è½ç©º`);
        }
        else if (card === 'å†³æ–—') {
            log(`${source.general.name} å‘ ${target.general.name} å‘èµ·ã€å†³æ–—ã€‘`, "skill");
            SFX.duel();
            // ç®€åŒ–é€»è¾‘ï¼šç›®æ ‡éœ€å‡ºæ€ï¼Œå¦åˆ™å—ä¼¤ã€‚è‹¥å‡ºæ€ï¼Œæºéœ€å‡ºæ€ï¼Œå¦åˆ™å—ä¼¤ã€‚
            // ç®€å•å®ç°ï¼šåªåˆ¤å®šä¸€è½®ã€‚ç›®æ ‡æ²¡æ€->å—ä¼¤ï¼›ç›®æ ‡æœ‰æ€->æºæ²¡æ€->æºå—ä¼¤ï¼›éƒ½æœ‰->å¹³å±€(ç®€åŒ–)
            let tHasSha = target.hand.indexOf('æ€');
            if (tHasSha === -1) {
                log(`${target.general.name} æ— æ€å¯å‡ºï¼Œå†³æ–—å¤±è´¥`, "damage");
                damage(source, target);
            } else {
                target.hand.splice(tHasSha, 1);
                log(`${target.general.name} æ‰“å‡ºã€æ€ã€‘å›å‡»`, "skill");
                let sHasSha = source.hand.indexOf('æ€');
                if (sHasSha === -1) {
                    log(`${source.general.name} æ— æ€æ‹›æ¶ï¼Œå†³æ–—åå™¬`, "damage");
                    damage(target, source);
                } else {
                    source.hand.splice(sHasSha, 1);
                    log(`${source.general.name} å†æ¬¡å‡ºã€æ€ã€‘ï¼ŒåŒæ–¹æ‹‰å¼€è·ç¦»`, "skill");
                }
            }
        }
        else if (card === 'ç«æ”»') {
            log(`${source.general.name} å¯¹ ${target.general.name} å‘åŠ¨ã€ç«æ”»ã€‘`, "skill");
            // ç®€åŒ–ï¼šç›®æ ‡å¼ƒä¸€å¼ ç‰Œï¼Œå¦åˆ™å—ä¼¤
            if (target.hand.length > 0) {
                // AI/Target ç®€å•é€»è¾‘ï¼šæœ‰ç‰Œå°±å¼ƒï¼Œä¿å‘½
                const discardIdx = Math.floor(Math.random() * target.hand.length);
                target.hand.splice(discardIdx, 1);
                log(`${target.general.name} å¼ƒç½®ä¸€å¼ ç‰ŒæŠµæ¶ˆç«æ”»`, "skill");
            } else {
                log(`${target.general.name} æ— ç‰Œå¯å¼ƒï¼Œçƒˆç«ç„šèº«`, "damage");
                damage(source, target);
            }
        }
        renderAll();
    }

    function resolveAttack(source, target, type) {
        let need = type === 'nanman' ? 'æ€' : 'é—ª';
        let idx = target.hand.indexOf(need);

        // æŠ€èƒ½åˆ¤å®š
        if ((source.general.name === 'å•å¸ƒ' || source.general.name === 'è®¸è¤š') && type === 'sha') {
            if (Math.random() > 0.5) idx = -1; // ç®€å•æ¨¡æ‹Ÿå¼ºå‘½
        }
        if (target.general.name === 'èµµäº‘' && idx === -1) {
            if (need === 'é—ª') idx = target.hand.indexOf('æ€');
            else idx = target.hand.indexOf('é—ª');
        }

        if (idx !== -1) {
            target.hand.splice(idx, 1);
            log(`${target.general.name} æ‰“å‡ºã€${need}ã€‘æŠµæ¶ˆ`, "skill");
            SFX.card();
        } else {
            damage(source, target);
        }
    }

    function damage(source, target) {
        target.hp--;
        log(`${target.general.name} å—åˆ°ä¼¤å®³`, "damage");
        SFX.damage();
        triggerDamageSkill(target);
        if (target.hp <= 0) {
            const tao = target.hand.indexOf('æ¡ƒ');
            if (tao !== -1) {
                target.hand.splice(tao, 1);
                target.hp++;
                log(`${target.general.name} æ¿’æ­»åƒæ¡ƒ`, "skill");
                SFX.heal();
            } else handleDeath(source, target);
        }
    }

    function triggerDamageSkill(p) {
        if (p.isDead) return;
        if (p.general.name === 'æ›¹æ“') { log(`ã€å¥¸é›„ã€‘${p.general.name}æ‘¸1ç‰Œ`, "skill"); drawCards(p, 1); }
        if (p.general.name === 'éƒ­å˜‰') { log(`ã€é—è®¡ã€‘${p.general.name}æ‘¸2ç‰Œ`, "skill"); drawCards(p, 2); }
    }

    function handleDeath(killer, dead) {
        dead.isDead = true; dead.identityKnown = true;
        log(`${dead.general.name} é˜µäº¡! èº«ä»½: ${dead.role}`, "damage");
        
        // å¥–æƒ©æœºåˆ¶
        if (dead.role === 'åè´¼') {
            log(`${killer.general.name} å‡»æ€åè´¼ï¼Œæ‘¸3å¼ ç‰Œ`, "system");
            drawCards(killer, 3);
        }
        else if (dead.role === 'å¿ è‡£' && killer.role === 'ä¸»å…¬') {
            log("ä¸»å…¬è¯¯æ€å¿ è‡£ï¼Œå¼ƒç½®æ‰€æœ‰ç‰Œ", "damage");
            killer.hand = [];
        }
        checkWin();
    }

    // --- AI é€»è¾‘ ---
    function aiAction(ai) {
        if (ai.isDead || !gameActive) return;
        
        // 1. å›å¤/å¢ç›Š
        if (ai.hand.includes('æ— ä¸­')) { useCard(ai, ai.hand.indexOf('æ— ä¸­'), null); if(!gameActive) return; }
        if (ai.hand.includes('äº”è°·')) { useCard(ai, ai.hand.indexOf('äº”è°·'), null); if(!gameActive) return; }
        while (ai.hp < ai.maxHp && ai.hand.includes('æ¡ƒ')) useCard(ai, ai.hand.indexOf('æ¡ƒ'), ai);
        if (ai.hand.includes('é…’') && (ai.hp < ai.maxHp || (ai.hand.includes('æ€') && ai.hasAttacked))) { useCard(ai, ai.hand.indexOf('é…’'), ai); }
        
        // 2. AOE
        if (ai.hand.includes('ä¸‡ç®­')) { useCard(ai, ai.hand.indexOf('ä¸‡ç®­'), null); if(!gameActive) return; }
        if (ai.hand.includes('å—è›®')) { useCard(ai, ai.hand.indexOf('å—è›®'), null); if(!gameActive) return; }

        // 3. ç¡®å®šç›®æ ‡
        const alive = players.filter(p => !p.isDead && p !== ai);
        let target = null;
        
        // ç®€å•AIç­–ç•¥
        if (ai.role === 'åè´¼') {
            // ä¼˜å…ˆæ‰“ä¸»å…¬ï¼Œå…¶æ¬¡æ‰“å·²äº®æ˜çš„å¿ è‡£
            target = alive.find(p => p.role === 'ä¸»å…¬');
            if (!target) target = alive.find(p => p.identityKnown && p.role === 'å¿ è‡£');
        } else if (ai.role === 'å¿ è‡£') {
            // æ‰“åè´¼
            target = alive.find(p => p.identityKnown && p.role === 'åè´¼');
        } else if (ai.role === 'ä¸»å…¬') {
            // æ‰“åè´¼æˆ–å†…å¥¸
            target = alive.find(p => p.identityKnown && (p.role === 'åè´¼' || p.role === 'å†…å¥¸'));
        } else { // å†…å¥¸
            // éšæœºæ‰“ï¼Œæˆ–è€…æ‰“ä¸»å…¬ä»¥å¤–çš„äºº
            target = alive.find(p => p.role !== 'ä¸»å…¬');
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°æ˜ç¡®ç›®æ ‡ï¼Œéšæœºé€‰ä¸€ä¸ªéé˜Ÿå‹ï¼ˆç®€åŒ–ï¼‰
        if (!target) target = alive[Math.floor(Math.random()*alive.length)];

        // 4. æ”»å‡»æ€§é”¦å›Š
        if (target && !target.isDead) {
            if (ai.hand.includes('é¡ºæ‰‹')) useCard(ai, ai.hand.indexOf('é¡ºæ‰‹'), target);
            if (ai.hand.includes('æ‹†æ¡¥')) useCard(ai, ai.hand.indexOf('æ‹†æ¡¥'), target);
            if (ai.hand.includes('ç«æ”»') && ai.hand.length > 2) useCard(ai, ai.hand.indexOf('ç«æ”»'), target);
            if (ai.hand.includes('å†³æ–—')) useCard(ai, ai.hand.indexOf('å†³æ–—'), target);
            
            // 5. æ€
            if (ai.hand.includes('æ€')) {
                if (!ai.hasAttacked || ai.general.name === 'å¼ é£') useCard(ai, ai.hand.indexOf('æ€'), target);
            }
        }

        setTimeout(nextTurn, 800);
    }

    // --- è¾…åŠ© ---
    function drawCards(p, n) {
        for(let i=0; i<n; i++) {
            if (deck.length===0) { deck=[...DECK_TEMPLATE]; shuffle(deck); }
            p.hand.push(deck.pop());
        }
    }
    function shuffle(arr) { for(let i=arr.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    function log(msg, type="") {
        const box = document.getElementById('log-zone');
        const div = document.createElement('div');
        div.className = `log-line ${type==='turn'?'log-turn':(type==='damage'?'log-damage':(type==='skill'?'log-skill':(type==='system'?'log-system':'')))}`;
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
    
    function checkWin() {
        const lord = players.find(p => p.role === 'ä¸»å…¬');
        const rebels = players.filter(p => p.role === 'åè´¼' && !p.isDead);
        const traitor = players.filter(p => p.role === 'å†…å¥¸' && !p.isDead);
        const loyalists = players.filter(p => p.role === 'å¿ è‡£' && !p.isDead);

        if (!lord) return; // Should not happen

        if (lord.isDead) {
            // ä¸»å…¬æ­»ï¼Œåè´¼èµ¢ï¼ˆé™¤éåªå‰©å†…å¥¸ï¼‰
            if (rebels.length === 0 && loyalists.length === 0 && traitor.length > 0) {
                gameOver(userRole === 'å†…å¥¸', "å†…å¥¸ç¯¡ä½ï¼Œå¤©ä¸‹å½’ä¸€ï¼");
            } else {
                gameOver(userRole === 'åè´¼', "ä¸»å…¬é˜µäº¡ï¼Œåè´¼èµ·ä¹‰æˆåŠŸï¼");
            }
        } else {
            // ä¸»å…¬æ´»
            if (rebels.length === 0 && traitor.length === 0) {
                gameOver(userRole === 'ä¸»å…¬' || userRole === 'å¿ è‡£', "é€†è´¼å…¨ç­ï¼Œå¤©ä¸‹å¤§å®šï¼");
            }
        }
    }

    function gameOver(win, msg) {
        gameActive = false;
        const t = document.getElementById('result-title');
        t.innerText = msg; t.className = win ? 'win' : 'lose';
        document.getElementById('result-overlay').style.display = 'flex';
        win ? SFX.win() : SFX.lose();
        stopBGM();
    }

    function showHelp() { document.getElementById('help-overlay').style.display = 'flex'; }

    // --- æ¸²æŸ“ ---
    function renderAll() {
        const container = document.getElementById('enemy-zone');
        container.innerHTML = '';
        // æ¸²æŸ“é™¤äº†ç©å®¶ä»¥å¤–çš„äºº (1, 2, 3)
        for(let i=1; i<=3; i++) {
            const p = players[i];
            const div = document.createElement('div');
            let roleText = p.identityKnown ? p.role : "???";
            let classes = `enemy-card ${p.isDead ? 'dead' : ''} ${currentTurnIndex === i ? 'active-turn' : ''}`;
            if (isTargetingMode && !p.isDead) classes += ' targetable';
            if (p.role === 'ä¸»å…¬') classes += ' lord-border'; // ä¸»å…¬é‡‘æ¡†
            
            div.className = classes;
            div.onclick = () => selectTarget(i);
            div.innerHTML = `
                <div class="role-badge" style="background:${p.identityKnown?(p.role==='åè´¼'?'#2ecc71':(p.role==='å¿ è‡£'?'#e67e22':(p.role==='ä¸»å…¬'?'#f1c40f':'#9b59b6'))):'#333'}; color:${p.role==='ä¸»å…¬'?'#000':'#fff'}">${roleText}</div>
                <div class="avatar-frame" style="color:${p.general.color}">${p.general.avatar}</div>
                <div class="info-block">
                    <div class="general-name">${p.general.name}</div>
                    <div class="hp-bar">${getHpHtml(p.hp, p.maxHp)}</div>
                    <div style="font-size:10px; color:#7f8c8d;">æ‰‹ç‰Œ: ${p.hand.length}</div>
                </div>
            `;
            container.appendChild(div);
        }
        document.getElementById('my-hp-bar').innerHTML = getHpHtml(players[0].hp, players[0].maxHp);
        updateHandUI();
    }
    function getHpHtml(hp, max) {
        let h = ''; for(let i=0; i<max; i++) h += `<div class="hp-point ${i<hp?'':'hp-lost'}"></div>`; return h;
    }
    function updateHandUI() {
        const c = document.getElementById('hand-scroll-container'); c.innerHTML = '';
        players[0].hand.forEach((card, i) => {
            const el = document.createElement('div');
            el.className = `card ${i===selectedCardIndex?'selected':''}`;
            el.setAttribute('data-type', card);
            el.onclick = () => selectCard(i);
            let icon = '';
            if(card==='æ€') icon='âš”ï¸'; if(card==='é—ª') icon='ğŸ’¨'; if(card==='æ¡ƒ') icon='ğŸ‘'; if(card==='é…’') icon='ğŸ¶';
            if(card==='ä¸‡ç®­') icon='ğŸ¹'; if(card==='å—è›®') icon='ğŸ˜'; if(card==='æ— ä¸­') icon='ğŸ';
            if(card==='é¡ºæ‰‹') icon='ğŸ”—'; if(card==='æ‹†æ¡¥') icon='ğŸª“';
            if(card==='å†³æ–—') icon='âš”ï¸'; if(card==='äº”è°·') icon='ğŸŒ¾'; if(card==='ç«æ”»') icon='ğŸ”¥';
            el.innerHTML = `<div class="card-icon">${icon}</div><div class="card-text">${card}</div>`;
            c.appendChild(el);
        });
    }
    function updateButtons() {
        const isMyTurn = currentTurnIndex === 0;
        const hasSel = selectedCardIndex !== -1;
        const card = hasSel ? players[0].hand[selectedCardIndex] : null;
        document.getElementById('btn-end').disabled = !isMyTurn;
        document.getElementById('btn-cancel').disabled = !hasSel;
        let can = false;
        if (isMyTurn && hasSel) {
            if (card === 'æ¡ƒ' && players[0].hp < players[0].maxHp) can = true;
            if (card === 'é…’') can = true;
            if (['ä¸‡ç®­', 'å—è›®', 'æ— ä¸­', 'äº”è°·'].includes(card)) can = true;
        }
        document.getElementById('btn-confirm').disabled = !can;
    }

</script>
</body>
</html>
