<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å›½æ€ Lite - æˆ˜ç«è¿å¤©ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: rgba(44, 62, 80, 0.9);
            --paper-color: #f3e5ab;
            --gold: #d4af37;
            --red: #c0392b;
            --blue: #2980b9;
            --green: #27ae60;
            --purple: #8e44ad;
            --text-color: #ecf0f1;
            --font-main: "Kaiti", "STKaiti", "KaiTi", "Georgia", serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: var(--bg-color);
            background-image: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            color: var(--text-color);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- åŠ¨ç”»ç‰¹æ•ˆå±‚ --- */
        #fx-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }
        .fx-text {
            position: absolute;
            font-size: 40px; font-weight: bold;
            color: #fff; text-shadow: 0 0 10px #000, 0 0 20px var(--gold);
            opacity: 0;
            animation: zoomFade 1.2s ease-out forwards;
        }
        .fx-damage { color: var(--red); text-shadow: 0 0 10px #000; font-size: 50px; }
        .fx-skill { color: var(--blue); font-size: 30px; border: 2px solid var(--blue); padding: 5px 15px; background: rgba(0,0,0,0.7); }
        
        @keyframes zoomFade {
            0% { transform: scale(0.5); opacity: 0; }
            20% { transform: scale(1.2); opacity: 1; }
            80% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* --- é¡¶éƒ¨æ  --- */
        #top-bar {
            height: 45px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--gold);
            z-index: 10;
        }
        .game-title { font-size: 18px; font-weight: bold; color: var(--gold); letter-spacing: 2px; text-shadow: 0 0 5px #000; }
        .top-btns { display: flex; gap: 10px; }
        .icon-btn { 
            width: 32px; height: 32px; border-radius: 50%; font-size: 16px; 
            display: flex; justify-content: center; align-items: center; 
            background: #34495e; border: 1px solid var(--gold); color: var(--gold);
        }

        /* --- æˆ˜åœºåŒºåŸŸ --- */
        #enemy-zone {
            flex: 0 0 28%; display: flex; justify-content: space-around; align-items: center;
            padding: 10px 5px; border-bottom: 1px solid #555;
        }

        .enemy-card {
            width: 30%; height: 100%;
            background: #2c3e50; border: 2px solid #555; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center;
            position: relative; transition: all 0.3s;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .enemy-card.active-turn { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.05); z-index: 2; }
        .enemy-card.dead { opacity: 0.4; filter: grayscale(100%); border-style: dashed; }
        .enemy-card.targetable { border-color: var(--red); box-shadow: 0 0 15px var(--red); animation: shake 0.5s infinite; }
        .enemy-card.lord-border { border: 2px solid #f1c40f; }

        .avatar-frame {
            width: 100%; height: 55%;
            display: flex; justify-content: center; align-items: center;
            font-size: 36px; background: #34495e; border-bottom: 1px solid #555;
            position: relative;
        }
        .role-badge { 
            position: absolute; top: 2px; right: 2px; font-size: 10px; padding: 2px 5px; 
            background: #000; border: 1px solid #777; color: #fff; border-radius: 3px;
        }
        /* çŠ¶æ€å›¾æ ‡å®¹å™¨ */
        .status-icons {
            position: absolute; bottom: 2px; left: 2px; display: flex; gap: 2px;
        }
        .status-icon { font-size: 12px; background: rgba(0,0,0,0.7); padding: 1px; border-radius: 3px; }

        .info-block { width: 100%; flex: 1; display: flex; flex-direction: column; justify-content: space-around; align-items: center; padding: 2px; }
        .general-name { font-size: 14px; font-weight: bold; color: var(--paper-color); text-shadow: 1px 1px 2px black; }
        
        /* --- æ—¥å¿—åŒºåŸŸ --- */
        #log-zone {
            flex: 1; background: rgba(0, 0, 0, 0.4);
            overflow-y: auto; padding: 10px 15px;
            font-size: 14px; color: #bdc3c7;
            border-bottom: 1px solid #555;
            font-family: "Courier New", Courier, monospace;
        }
        .log-line { margin-bottom: 5px; line-height: 1.4; }
        .log-turn { color: var(--gold); margin-top: 8px; border-top: 1px dashed #555; padding-top: 4px; font-weight: bold; }
        .log-damage { color: var(--red); font-weight: bold; }
        .log-skill { color: var(--blue); }
        .log-system { color: #27ae60; font-style: italic; }

        /* --- ç©å®¶åŒºåŸŸ --- */
        #player-zone {
            flex: 0 0 40%; display: flex; flex-direction: column;
            background: rgba(20, 20, 20, 0.95); padding: 5px;
            border-top: 2px solid var(--gold);
        }

        #player-status { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; height: 40px; }
        .my-info { display: flex; align-items: center; gap: 10px; }
        .my-role { font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .role-lord { background: #f1c40f; color: #000; }
        .role-loyal { background: #e67e22; color: #fff; }
        .role-rebel { background: #2ecc71; color: #fff; }
        .role-spy { background: #9b59b6; color: #fff; }

        .hp-bar { display: flex; gap: 3px; }
        .hp-point { 
            width: 14px; height: 14px; border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #2ecc71, #27ae60); 
            border: 1px solid #fff; box-shadow: 0 0 3px black; 
        }
        .hp-lost { background: #444; border-color: #666; }

        /* æ‰‹ç‰Œ */
        #hand-scroll-container {
            flex: 1; overflow-x: auto; white-space: nowrap;
            padding: 10px 5px; display: flex; align-items: center;
        }

        .card {
            display: inline-flex; flex-direction: column; justify-content: center; align-items: center;
            width: 75px; height: 105px;
            background: var(--paper-color); 
            border-radius: 5px; margin-right: 8px; flex-shrink: 0;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            transition: transform 0.2s;
            color: #333; font-weight: bold; border: 1px solid #d7ccc8;
        }
        .card.selected { transform: translateY(-20px); border: 2px solid var(--red); box-shadow: 0 0 15px var(--red); }

        .card[data-type="æ€"] { color: #8b0000; }
        .card[data-type="é—ª"] { color: #154360; }
        .card[data-type="æ¡ƒ"] { color: #d81b60; }
        .card[data-type="é…’"] { color: #a04000; }
        .card[data-type="ä¸‡ç®­"], .card[data-type="å—è›®"] { color: #6c3483; }
        .card[data-type="æ— ä¸­"], .card[data-type="äº”è°·"] { color: #1e8449; }
        .card[data-type="é¡ºæ‰‹"], .card[data-type="æ‹†æ¡¥"] { color: #117864; }
        .card[data-type="å†³æ–—"] { color: #000; border: 1px solid #000; }
        .card[data-type="ç«æ”»"] { color: #e74c3c; }
        .card[data-type="ä¹ä¸"] { color: #2c3e50; border: 1px solid #2980b9; }
        .card[data-type="é“ç´¢"] { color: #555; }

        .card-icon { font-size: 30px; margin-bottom: 5px; }
        .card-text { font-family: var(--font-main); font-size: 16px; }

        /* åº•éƒ¨æŒ‰é’® */
        #controls { height: 50px; display: flex; gap: 10px; padding: 5px; }
        .btn-action { flex: 1; font-size: 16px; font-weight: bold; border-radius: 4px; color: white; border: 1px solid rgba(255,255,255,0.2); }
        #btn-confirm { background: #d35400; }
        #btn-end { background: #27ae60; }
        #btn-cancel { background: #7f8c8d; }

        /* --- å¼¹çª— --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }

        /* é€‰å°†/é€‰èº«ä»½ç•Œé¢ */
        .select-container { width: 90%; max-width: 600px; text-align: center; }
        .select-title { font-size: 24px; color: var(--gold); margin-bottom: 20px; }
        
        .role-options, .hero-options { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        
        .role-card {
            width: 80px; height: 100px; background: #34495e; border: 2px solid #7f8c8d;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            cursor: pointer; color: white; border-radius: 8px;
        }
        .role-card:hover { border-color: var(--gold); background: #2c3e50; }

        .hero-option {
            width: 100px; height: 140px;
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .hero-option:hover { transform: scale(1.1); border-color: var(--gold); box-shadow: 0 0 20px var(--gold); }
        .hero-avatar { font-size: 40px; margin-bottom: 10px; }
        .hero-name { font-weight: bold; color: white; }
        .hero-skill { font-size: 12px; color: #bdc3c7; margin-top: 5px; }

        /* å¸®åŠ©ä¸ç»“ç®— */
        #result-title { font-size: 40px; margin-bottom: 20px; font-family: var(--font-main); }
        .win { color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .lose { color: var(--red); text-shadow: 0 0 10px var(--red); }

        .help-content {
            background: var(--paper-color); color: #333; padding: 20px; 
            border-radius: 5px; width: 90%; height: 85%; overflow-y: auto;
            font-size: 14px; line-height: 1.6;
        }
        .help-section { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .help-item { display: flex; align-items: center; margin-bottom: 8px; }
        .help-icon { width: 30px; font-size: 20px; text-align: center; margin-right: 10px; }

        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }

    </style>
</head>
<body>

    <!-- ç‰¹æ•ˆå±‚ -->
    <div id="fx-layer"></div>

    <!-- é¡¶éƒ¨æ  -->
    <div id="top-bar">
        <div class="game-title">ä¸‰å›½æ€Â·æˆ˜ç«è¿å¤©</div>
        <div class="top-btns">
            <button class="icon-btn" onclick="toggleBGM()" id="btn-bgm">ğŸµ</button>
            <button class="icon-btn" onclick="toggleSound()" id="btn-sound">ğŸ”Š</button>
            <button class="icon-btn" onclick="showHelp()">?</button>
        </div>
    </div>

    <!-- æ•Œæ–¹åŒºåŸŸ -->
    <div id="enemy-zone"></div>

    <!-- æ—¥å¿— -->
    <div id="log-zone">
        <div class="log-line">æ¬¢è¿æ¥åˆ°ä¸‰å›½æ€ Lite...</div>
    </div>

    <!-- ç©å®¶åŒºåŸŸ -->
    <div id="player-zone">
        <div id="player-status">
            <div class="my-info">
                <span id="my-role-badge" class="my-role"></span>
                <span id="my-avatar" style="font-size:24px;"></span>
                <span id="my-name" class="my-name"></span>
                <span id="my-skill" style="font-size:12px; color:#bdc3c7;"></span>
                <div id="my-status-icons" class="status-icons"></div>
            </div>
            <div class="hp-bar" id="my-hp-bar"></div>
        </div>
        
        <div id="hand-scroll-container"></div>

        <div id="controls">
            <button id="btn-confirm" class="btn-action" onclick="confirmAction()" disabled>å‡ºç‰Œ</button>
            <button id="btn-cancel" class="btn-action" onclick="cancelAction()" disabled>å–æ¶ˆ</button>
            <button id="btn-end" class="btn-action" onclick="endTurn()" disabled>ç»“æŸ</button>
        </div>
    </div>

    <!-- æµç¨‹å¼¹çª— -->
    <div id="setup-screen" class="overlay" style="display:flex;">
        <div id="step-role" class="select-container">
            <div class="select-title">ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä½ çš„èº«ä»½</div>
            <div class="role-options">
                <div class="role-card" onclick="selectRole('ä¸»å…¬')" style="border-color:#f1c40f">ä¸»å…¬</div>
                <div class="role-card" onclick="selectRole('å¿ è‡£')" style="border-color:#e67e22">å¿ è‡£</div>
                <div class="role-card" onclick="selectRole('åè´¼')" style="border-color:#2ecc71">åè´¼</div>
                <div class="role-card" onclick="selectRole('å†…å¥¸')" style="border-color:#9b59b6">å†…å¥¸</div>
            </div>
        </div>
        <div id="step-hero" class="select-container" style="display:none;">
            <div class="select-title">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä½ çš„æ­¦å°†</div>
            <div class="hero-options" id="hero-selection"></div>
        </div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div id="result-overlay" class="overlay">
        <div id="result-title"></div>
        <button class="btn-action" style="flex:0; padding:10px 30px;" onclick="location.reload()">å†æˆ˜æ±Ÿæ¹–</button>
    </div>

    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="help-overlay" class="overlay" onclick="this.style.display='none'">
        <div class="help-content" onclick="event.stopPropagation()">
            <h2 style="text-align:center; margin-top:0;">æ¸¸æˆè¯´æ˜ä¹¦</h2>
            
            <div class="help-section">
                <h3>ğŸ´ åŸºç¡€ç‰Œ</h3>
                <div class="help-item"><span class="help-icon">âš”ï¸</span> <b>æ€</b>ï¼šæ”»å‡»èŒƒå›´å†…çš„ä¸€åè§’è‰²ï¼Œéœ€ç”¨ã€é—ªã€‘æŠµæ¶ˆã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ’¨</span> <b>é—ª</b>ï¼šæŠµæ¶ˆã€æ€ã€‘æˆ–ã€ä¸‡ç®­é½å‘ã€‘çš„æ•ˆæœã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ‘</span> <b>æ¡ƒ</b>ï¼šå›åˆå†…å›å¤1ç‚¹ä½“åŠ›ï¼›æ¿’æ­»æ—¶å¯æ•‘è‡ªå·±æˆ–ä»–äººã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ¶</span> <b>é…’</b>ï¼šå›åˆå†…ä½¿ç”¨ï¼Œæœ¬å›åˆä¸‹ä¸€å¼ æ€ä¼¤å®³+1ï¼›æˆ–æ¿’æ­»æ—¶è‡ªæ•‘ã€‚</div>
            </div>

            <div class="help-section">
                <h3>ğŸ“œ é”¦å›Šç‰Œ</h3>
                <div class="help-item"><span class="help-icon">ğŸ¹</span> <b>ä¸‡ç®­é½å‘</b>ï¼šæ‰€æœ‰å…¶ä»–è§’è‰²éœ€æ‰“å‡ºä¸€å¼ ã€é—ªã€‘ï¼Œå¦åˆ™å—1ç‚¹ä¼¤å®³ã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ˜</span> <b>å—è›®å…¥ä¾µ</b>ï¼šæ‰€æœ‰å…¶ä»–è§’è‰²éœ€æ‰“å‡ºä¸€å¼ ã€æ€ã€‘ï¼Œå¦åˆ™å—1ç‚¹ä¼¤å®³ã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ</span> <b>æ— ä¸­ç”Ÿæœ‰</b>ï¼šæ‘¸2å¼ ç‰Œã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸŒ¾</span> <b>äº”è°·ä¸°ç™»</b>ï¼šå…¨åœºæ¯äººæ‘¸1å¼ ç‰Œã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ”—</span> <b>é¡ºæ‰‹ç‰µç¾Š</b>ï¼šè·å¾—è·ç¦»1ä»¥å†…çš„ä¸€åè§’è‰²ä¸€å¼ ç‰Œã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸª“</span> <b>è¿‡æ²³æ‹†æ¡¥</b>ï¼šå¼ƒç½®ä»»æ„ä¸€åè§’è‰²ä¸€å¼ ç‰Œã€‚</div>
                <div class="help-item"><span class="help-icon">âš”ï¸</span> <b>å†³æ–—</b>ï¼šä¸ç›®æ ‡è½®æµå‡ºã€æ€ã€‘ï¼Œä¸å‡ºè€…å—1ç‚¹ä¼¤å®³ã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ”¥</span> <b>ç«æ”»</b>ï¼šå¼ƒç½®ä¸€å¼ æ‰‹ç‰Œï¼Œç›®æ ‡éœ€å¼ƒç½®ä¸€å¼ ç‰Œï¼Œå¦åˆ™å—1ç‚¹ä¼¤å®³ã€‚</div>
                <div class="help-item"><span class="help-icon">â›“ï¸</span> <b>é“ç´¢è¿ç¯</b>ï¼šæŒ‡å®š1-2åè§’è‰²æ¨ªç½®/é‡ç½®ã€‚å¤„äºè¿ç¯çŠ¶æ€çš„è§’è‰²å—ä¼¤å®³æ—¶ï¼Œå…¶ä»–è¿ç¯è§’è‰²åŒå—ä¼¤å®³ã€‚</div>
                <div class="help-item"><span class="help-icon">ğŸ¤</span> <b>ä¹ä¸æ€èœ€</b>ï¼šå»¶æ—¶é”¦å›Šã€‚åˆ¤å®šé˜¶æ®µè‹¥åˆ¤å®šä¸ä¸ºçº¢æ¡ƒï¼Œåˆ™è·³è¿‡å‡ºç‰Œé˜¶æ®µã€‚</div>
            </div>

            <div class="help-section">
                <h3>ğŸ¦¸ æ­¦å°†æŠ€èƒ½</h3>
                <div class="help-item"><b>æ›¹æ“ã€å¥¸é›„ã€‘</b>ï¼šå—åˆ°ä¼¤å®³åï¼Œå¯ä»¥è·å¾—é€ æˆä¼¤å®³çš„ç‰Œã€‚</div>
                <div class="help-item"><b>å¼ é£ã€å’†å“®ã€‘</b>ï¼šå‡ºç‰Œé˜¶æ®µï¼Œä½¿ç”¨ã€æ€ã€‘æ— æ¬¡æ•°é™åˆ¶ã€‚</div>
                <div class="help-item"><b>èµµäº‘ã€é¾™èƒ†ã€‘</b>ï¼šã€æ€ã€‘å¯å½“ã€é—ªã€‘ï¼Œã€é—ªã€‘å¯å½“ã€æ€ã€‘ã€‚</div>
                <div class="help-item"><b>éƒ­å˜‰ã€é—è®¡ã€‘</b>ï¼šå—åˆ°1ç‚¹ä¼¤å®³åï¼Œå¯æ‘¸2å¼ ç‰Œã€‚</div>
                <div class="help-item"><b>å•å¸ƒã€æ— åŒã€‘</b>ï¼šä½¿ç”¨ã€æ€ã€‘éœ€2å¼ ã€é—ªã€‘æŠµæ¶ˆï¼›å†³æ–—æ—¶å¯¹æ–¹éœ€å‡º2å¼ ã€æ€ã€‘ã€‚</div>
                <div class="help-item"><b>åä½—ã€æ€¥æ•‘ã€‘</b>ï¼šå›åˆå¤–ï¼Œå¯å°†çº¢è‰²ç‰Œå½“ã€æ¡ƒã€‘ä½¿ç”¨ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰ã€‚</div>
                <div class="help-item"><b>åˆ˜å¤‡ã€ä»å¾·ã€‘</b>ï¼šå‡ºç‰Œé˜¶æ®µå¼€å§‹æ—¶ï¼Œé¢å¤–æ‘¸1å¼ ç‰Œï¼ˆç®€åŒ–ç‰ˆï¼‰ã€‚</div>
                <div class="help-item"><b>å‘¨ç‘œã€è‹±å§¿ã€‘</b>ï¼šæ‘¸ç‰Œé˜¶æ®µå¤šæ‘¸1å¼ ç‰Œï¼ˆç®€åŒ–ç‰ˆï¼‰ã€‚</div>
                <div class="help-item"><b>è®¸è¤šã€è£¸è¡£ã€‘</b>ï¼šæ‘¸ç‰Œé˜¶æ®µå°‘æ‘¸1å¼ ï¼Œæœ¬å›åˆã€æ€ã€‘æˆ–ã€å†³æ–—ã€‘ä¼¤å®³+1ã€‚</div>
                <div class="help-item"><b>å­™å°šé¦™ã€æ­å§¬ã€‘</b>ï¼šå¤±å»è£…å¤‡åŒºæˆ–æ‰‹ç‰Œä¸­çš„è£…å¤‡ç‰Œæ—¶ï¼Œæ‘¸2å¼ ç‰Œï¼ˆç®€åŒ–ä¸ºæ‰‹ç‰Œæ•°å°‘äºè¡€é‡æ—¶è¡¥ç‰Œï¼‰ã€‚</div>
            </div>
            
            <button class="btn-action" style="width:100%; margin-top:20px;" onclick="document.getElementById('help-overlay').style.display='none'">å…³é—­</button>
        </div>
    </div>

<script>
    // --- å·¥å…·å‡½æ•°ï¼šå¼‚æ­¥ç­‰å¾… ---
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // --- éŸ³æ•ˆä¸BGMç³»ç»Ÿ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;
    let bgmEnabled = false;
    let bgmOscillators = [];
    let bgmInterval;

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('btn-sound').innerText = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    }

    function toggleBGM() {
        bgmEnabled = !bgmEnabled;
        document.getElementById('btn-bgm').innerText = bgmEnabled ? 'ğŸµ' : 'âœ–ï¸';
        if (bgmEnabled) startBGM(); else stopBGM();
    }

    function startBGM() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const scale = [196.00, 220.00, 261.63, 293.66, 329.63, 392.00]; 
        function playNote() {
            if (!bgmEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const freq = scale[Math.floor(Math.random() * scale.length)];
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 1);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 4);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 4);
        }
        const drone = audioCtx.createOscillator();
        const droneGain = audioCtx.createGain();
        drone.type = 'triangle'; drone.frequency.value = 98.00; droneGain.gain.value = 0.02;
        drone.connect(droneGain); droneGain.connect(audioCtx.destination);
        drone.start();
        bgmOscillators.push(drone);
        playNote();
        bgmInterval = setInterval(playNote, 2500);
    }

    function stopBGM() {
        clearInterval(bgmInterval);
        bgmOscillators.forEach(o => o.stop());
        bgmOscillators = [];
    }

    function playTone(freq, type, duration, vol=0.1) {
        if (!soundEnabled) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const SFX = {
        card: () => playTone(800, 'triangle', 0.05, 0.05),
        attack: () => playTone(600, 'sawtooth', 0.1, 0.1),
        damage: () => playTone(100, 'square', 0.3, 0.2),
        heal: () => playTone(800, 'sine', 0.5, 0.1),
        aoe: () => { playTone(200, 'sawtooth', 0.4, 0.1); setTimeout(()=>playTone(150, 'sawtooth', 0.4, 0.1), 100); },
        duel: () => { playTone(400, 'square', 0.1); setTimeout(()=>playTone(400, 'square', 0.1), 150); },
        win: () => { playTone(400, 'triangle', 0.2); setTimeout(()=>playTone(600, 'triangle', 0.4), 200); },
        lose: () => { playTone(300, 'sawtooth', 0.5); setTimeout(()=>playTone(200, 'sawtooth', 0.5), 400); }
    };

    // --- è§†è§‰ç‰¹æ•ˆç³»ç»Ÿ ---
    async function showEffect(targetId, text, type='normal') {
        const layer = document.getElementById('fx-layer');
        const el = document.createElement('div');
        el.innerText = text;
        el.className = `fx-text ${type==='damage'?'fx-damage':(type==='skill'?'fx-skill':'')}`;
        
        // ç®€å•å®šä½ï¼šå¦‚æœæ˜¯ç©å®¶(0)ï¼Œåœ¨ä¸‹æ–¹ï¼›å¦‚æœæ˜¯æ•Œäººï¼Œåœ¨ä¸Šæ–¹å¯¹åº”ä½ç½®
        // è¿™é‡Œç®€åŒ–ä¸ºå±å¹•ä¸­å¤®æ˜¾ç¤ºï¼Œæˆ–è€…æ ¹æ®IDå¾®è°ƒ
        if (targetId === 0) el.style.bottom = '20%';
        else if (targetId === 1) { el.style.top = '20%'; el.style.right = '10%'; }
        else if (targetId === 2) { el.style.top = '20%'; }
        else if (targetId === 3) { el.style.top = '20%'; el.style.left = '10%'; }
        
        layer.appendChild(el);
        await sleep(1000); // ç­‰å¾…åŠ¨ç”»
        el.remove();
    }

    // --- æ¸¸æˆæ•°æ® ---
    const GENERALS_DATA = [
        { name: 'æ›¹æ“', hp: 5, skill: 'å¥¸é›„', avatar: 'ğŸ‘‘', color: '#8e44ad' },
        { name: 'å¼ é£', hp: 4, skill: 'å’†å“®', avatar: 'ğŸ‘¹', color: '#c0392b' },
        { name: 'éƒ­å˜‰', hp: 3, skill: 'é—è®¡', avatar: 'ğŸ”®', color: '#2980b9' },
        { name: 'èµµäº‘', hp: 4, skill: 'é¾™èƒ†', avatar: 'ğŸ›¡ï¸', color: '#95a5a6' },
        { name: 'å•å¸ƒ', hp: 5, skill: 'æ— åŒ', avatar: 'ğŸ”¥', color: '#e74c3c' },
        { name: 'åä½—', hp: 3, skill: 'æ€¥æ•‘', avatar: 'ğŸŒ¿', color: '#27ae60' },
        { name: 'åˆ˜å¤‡', hp: 4, skill: 'ä»å¾·', avatar: 'ğŸ‰', color: '#2ecc71' },
        { name: 'å‘¨ç‘œ', hp: 4, skill: 'è‹±å§¿', avatar: 'ğŸ”¥', color: '#e67e22' },
        { name: 'è®¸è¤š', hp: 4, skill: 'è£¸è¡£', avatar: 'ğŸ›¡ï¸', color: '#7f8c8d' },
        { name: 'å­™å°šé¦™', hp: 4, skill: 'æ­å§¬', avatar: 'ğŸ€', color: '#e91e63' }
    ];

    const DECK_TEMPLATE = [
        ...Array(24).fill('æ€'), ...Array(12).fill('é—ª'), ...Array(8).fill('æ¡ƒ'), ...Array(4).fill('é…’'),
        ...Array(2).fill('ä¸‡ç®­'), ...Array(2).fill('å—è›®'), ...Array(3).fill('æ— ä¸­'),
        ...Array(3).fill('é¡ºæ‰‹'), ...Array(3).fill('æ‹†æ¡¥'),
        ...Array(3).fill('å†³æ–—'), ...Array(2).fill('äº”è°·'), ...Array(3).fill('ç«æ”»'),
        ...Array(3).fill('ä¹ä¸'), ...Array(3).fill('é“ç´¢')
    ];

    let players = [];
    let deck = [];
    let currentTurnIndex = 0;
    let selectedCardIndex = -1;
    let isTargetingMode = false;
    let gameActive = false;
    let userRole = '';

    function requiresTarget(card) {
        return ['æ€', 'é¡ºæ‰‹', 'æ‹†æ¡¥', 'å†³æ–—', 'ç«æ”»', 'ä¹ä¸', 'é“ç´¢'].includes(card);
    }

    // --- åˆå§‹åŒ– ---
    function selectRole(role) {
        userRole = role;
        document.getElementById('step-role').style.display = 'none';
        showHeroSelection();
    }

    function showHeroSelection() {
        const container = document.getElementById('hero-selection');
        let pool = [...GENERALS_DATA];
        shuffle(pool);
        pool.slice(0, 4).forEach(hero => {
            const el = document.createElement('div');
            el.className = 'hero-option';
            el.innerHTML = `<div class="hero-avatar" style="color:${hero.color}">${hero.avatar}</div><div class="hero-name">${hero.name}</div><div class="hero-skill">${hero.skill}</div>`;
            el.onclick = () => startGame(hero);
            container.appendChild(el);
        });
        document.getElementById('step-hero').style.display = 'block';
    }

    function startGame(selectedHero) {
        document.getElementById('setup-screen').style.display = 'none';
        gameActive = true;
        SFX.win();

        deck = [...DECK_TEMPLATE];
        shuffle(deck);

        let roles = ['ä¸»å…¬', 'å¿ è‡£', 'åè´¼', 'å†…å¥¸'];
        roles.splice(roles.indexOf(userRole), 1);
        shuffle(roles);

        let aiPool = GENERALS_DATA.filter(g => g.name !== selectedHero.name);
        shuffle(aiPool);

        players = [];
        // ç©å®¶
        players.push(createPlayer(0, true, userRole, selectedHero));
        // AI
        for(let i=0; i<3; i++) players.push(createPlayer(i+1, false, roles[i], aiPool[i]));

        players.forEach(p => drawCards(p, 4));

        // UI Setup
        document.getElementById('my-avatar').innerText = selectedHero.avatar;
        document.getElementById('my-name').innerText = selectedHero.name;
        document.getElementById('my-skill').innerText = `[${selectedHero.skill}]`;
        const badge = document.getElementById('my-role-badge');
        badge.innerText = userRole;
        badge.className = `my-role role-${userRole==='ä¸»å…¬'?'lord':(userRole==='å¿ è‡£'?'loyal':(userRole==='åè´¼'?'rebel':'spy'))}`;
        
        renderAll();
        
        let lordIndex = players.findIndex(p => p.role === 'ä¸»å…¬');
        log(`æ¸¸æˆå¼€å§‹ï¼Œ${players[lordIndex].general.name} (ä¸»å…¬) å…ˆæ‰‹ï¼`, "system");
        startTurn(lordIndex);
    }

    function createPlayer(id, isUser, role, general) {
        return {
            id, isUser, role, general,
            hp: general.hp + (role==='ä¸»å…¬'?1:0), maxHp: general.hp + (role==='ä¸»å…¬'?1:0),
            hand: [], isDead: false, hasAttacked: false, berserk: false,
            identityKnown: role === 'ä¸»å…¬',
            lebu: false, chained: false
        };
    }

    // --- æ ¸å¿ƒæµç¨‹ (Async) ---
    async function startTurn(idx) {
        if (!gameActive) return;
        currentTurnIndex = idx;
        const p = players[idx];

        if (p.isDead) { nextTurn(); return; }

        p.hasAttacked = false;
        p.berserk = false;
        renderAll();
        log(`--- ${p.general.name} å›åˆ ---`, "turn");

        // 1. åˆ¤å®šé˜¶æ®µ (ä¹ä¸æ€èœ€)
        if (p.lebu) {
            log(`${p.general.name} åˆ¤å®šã€ä¹ä¸æ€èœ€ã€‘...`, "system");
            await showEffect(p.id, "åˆ¤å®šä¸­...", "skill");
            // ç®€å•åˆ¤å®šï¼š50%æ¦‚ç‡
            let success = Math.random() > 0.5; 
            p.lebu = false; // ç§»é™¤çŠ¶æ€
            if (!success) {
                log(`åˆ¤å®šå¤±è´¥ï¼${p.general.name} è·³è¿‡å‡ºç‰Œé˜¶æ®µ`, "damage");
                await showEffect(p.id, "ä¹ä¸æ€èœ€ç”Ÿæ•ˆ", "damage");
                renderAll();
                await sleep(1000);
                nextTurn();
                return;
            } else {
                log("åˆ¤å®šæˆåŠŸï¼Œå¤©å‘½çœ·é¡¾ï¼", "skill");
                await showEffect(p.id, "åˆ¤å®šæˆåŠŸ", "skill");
            }
        }

        // 2. æ‘¸ç‰Œé˜¶æ®µ
        if (p.general.name === 'å‘¨ç‘œ') { log(`ã€è‹±å§¿ã€‘æ‘¸3ç‰Œ`, 'skill'); drawCards(p, 3); }
        else if (p.general.name === 'è®¸è¤š') { log(`ã€è£¸è¡£ã€‘æ‘¸1ç‰Œï¼Œä¼¤å®³+1`, 'skill'); drawCards(p, 1); p.berserk = true; } // ç®€åŒ–è£¸è¡£é€»è¾‘
        else drawCards(p, 2);
        
        if (p.general.name === 'åˆ˜å¤‡') { log(`ã€ä»å¾·ã€‘é¢å¤–æ‘¸1ç‰Œ`, 'skill'); drawCards(p, 1); }
        
        renderAll();
        await sleep(500);

        // 3. å‡ºç‰Œé˜¶æ®µ
        if (p.isUser) {
            updateHandUI();
            updateButtons();
        } else {
            updateButtons();
            await aiAction(p);
        }
    }

    function nextTurn() {
        checkWin();
        if (!gameActive) return;
        startTurn((currentTurnIndex + 1) % 4);
    }

    // --- ç©å®¶äº¤äº’ ---
    function selectCard(idx) {
        if (!players[0].isUser || currentTurnIndex !== 0) return;
        SFX.card();
        if (selectedCardIndex === idx) cancelAction();
        else {
            selectedCardIndex = idx;
            const card = players[0].hand[idx];
            isTargetingMode = requiresTarget(card);
            if (isTargetingMode) log("è¯·é€‰æ‹©ç›®æ ‡...");
            updateHandUI(); updateButtons(); renderEnemies();
        }
    }

    function selectTarget(id) {
        if (!isTargetingMode || selectedCardIndex === -1) return;
        const target = players[id];
        if (target.isDead) return;
        const p = players[0];
        const card = p.hand[selectedCardIndex];
        
        if (card === 'æ€' && p.hasAttacked && p.general.name !== 'å¼ é£') {
            log("æœ¬å›åˆå·²å‡ºè¿‡æ€"); cancelAction(); return;
        }
        if (card === 'ä¹ä¸' && target.lebu) { log("ç›®æ ‡å·²æœ‰ä¹ä¸æ€èœ€"); return; }
        if (card === 'é“ç´¢' && target.id === p.id) { /* Allow self chain */ }

        confirmUseCard(p, selectedCardIndex, target);
        cancelAction();
    }

    function confirmAction() {
        const p = players[0];
        confirmUseCard(p, selectedCardIndex, p); // Self target or AOE
        cancelAction();
    }

    function cancelAction() {
        selectedCardIndex = -1; isTargetingMode = false;
        updateHandUI(); updateButtons(); renderEnemies();
    }

    // --- å¡ç‰Œé€»è¾‘ (Async) ---
    async function confirmUseCard(source, idx, target) {
        const card = source.hand[idx];
        source.hand.splice(idx, 1);
        SFX.card();
        renderAll();

        await showEffect(source.id, card); // å±•ç¤ºå‡ºç‰Œç‰¹æ•ˆ

        if (card === 'æ€') {
            log(`${source.general.name} å¯¹ ${target.general.name} å‡ºã€æ€ã€‘`);
            SFX.attack();
            source.hasAttacked = true;
            await resolveAttack(source, target, 'sha');
        } 
        else if (card === 'æ¡ƒ') {
            if (target.hp < target.maxHp) {
                target.hp++;
                log(`${source.general.name} åƒã€æ¡ƒã€‘å›è¡€`, "skill");
                SFX.heal();
                await showEffect(target.id, "+1 ä½“åŠ›", "skill");
            }
        } 
        else if (card === 'é…’') {
            if (target.hp < target.maxHp) { target.hp++; SFX.heal(); }
            source.berserk = true;
            log(`${source.general.name} é¥®ã€é…’ã€‘`, 'skill');
            await showEffect(source.id, "é…’åŠ²å¤§å‘", "skill");
        } 
        else if (card === 'ä¸‡ç®­' || card === 'å—è›®') {
            log(`${source.general.name} é‡Šæ”¾ã€${card}ã€‘`, "skill");
            SFX.aoe();
            for (let p of players) {
                if (p !== source && !p.isDead) await resolveAttack(source, p, card === 'ä¸‡ç®­' ? 'wanjian' : 'nanman');
            }
        } 
        else if (card === 'æ— ä¸­') {
            log(`${source.general.name} ã€æ— ä¸­ç”Ÿæœ‰ã€‘`, "skill");
            SFX.heal();
            drawCards(source, 2);
        } 
        else if (card === 'äº”è°·') {
            log(`${source.general.name} ã€äº”è°·ä¸°ç™»ã€‘`, "skill");
            SFX.heal();
            players.forEach(p => { if(!p.isDead) drawCards(p, 1); });
        }
        else if (card === 'é¡ºæ‰‹') {
            if (target.hand.length > 0) {
                const stealIdx = Math.floor(Math.random() * target.hand.length);
                const got = target.hand.splice(stealIdx, 1)[0];
                source.hand.push(got);
                log(`${source.general.name} é¡ºèµ° ${target.general.name} ä¸€å¼ ç‰Œ`, 'skill');
                await showEffect(target.id, "è¢«é¡ºæ‰‹", "damage");
            }
        } 
        else if (card === 'æ‹†æ¡¥') {
            if (target.hand.length > 0) {
                const discardIdx = Math.floor(Math.random() * target.hand.length);
                target.hand.splice(discardIdx, 1);
                log(`${source.general.name} æ‹†æ‰ ${target.general.name} ä¸€å¼ ç‰Œ`, 'skill');
                await showEffect(target.id, "è¢«æ‹†æ¡¥", "damage");
            }
        }
        else if (card === 'å†³æ–—') {
            log(`${source.general.name} å†³æ–— ${target.general.name}`, "skill");
            SFX.duel();
            // ç®€åŒ–å†³æ–—ï¼šç›®æ ‡æ— æ€åˆ™ä¼¤ï¼Œæœ‰æ€åˆ™æºä¼¤ (åªåˆ¤å®šä¸€è½®)
            await sleep(500);
            let tHasSha = target.hand.indexOf('æ€');
            if (tHasSha === -1) {
                await damage(source, target);
            } else {
                target.hand.splice(tHasSha, 1);
                log(`${target.general.name} æ‰“å‡ºã€æ€ã€‘åå‡»`, "skill");
                await showEffect(target.id, "æ€!", "normal");
                await sleep(500);
                let sHasSha = source.hand.indexOf('æ€');
                if (sHasSha === -1) {
                    await damage(target, source);
                } else {
                    source.hand.splice(sHasSha, 1);
                    log("åŒæ–¹å¹³æ‰‹", "system");
                }
            }
        }
        else if (card === 'ç«æ”»') {
            log(`${source.general.name} ç«æ”» ${target.general.name}`, "skill");
            if (target.hand.length > 0) {
                const discardIdx = Math.floor(Math.random() * target.hand.length);
                target.hand.splice(discardIdx, 1);
                log(`${target.general.name} å¼ƒç‰ŒæŠµæ¶ˆ`, "skill");
                await showEffect(target.id, "å¼ƒç‰ŒæŠµæ¶ˆ", "normal");
            } else {
                await damage(source, target);
            }
        }
        else if (card === 'ä¹ä¸') {
            target.lebu = true;
            log(`${source.general.name} å¯¹ ${target.general.name} ä½¿ç”¨ã€ä¹ä¸æ€èœ€ã€‘`, "skill");
            await showEffect(target.id, "ä¹ä¸æ€èœ€", "skill");
        }
        else if (card === 'é“ç´¢') {
            target.chained = !target.chained;
            log(`${target.general.name} ${target.chained?'è¿›å…¥':'è§£é™¤'}è¿ç¯çŠ¶æ€`, "skill");
            await showEffect(target.id, target.chained?"è¿ç¯":"è§£é™¤", "skill");
        }
        renderAll();
        if (!source.isUser) await sleep(800); // AI pause
    }

    async function resolveAttack(source, target, type) {
        let need = type === 'nanman' ? 'æ€' : 'é—ª';
        let idx = target.hand.indexOf(need);

        // æŠ€èƒ½åˆ¤å®š
        if ((source.general.name === 'å•å¸ƒ' || source.general.name === 'è®¸è¤š') && type === 'sha') {
            if (Math.random() > 0.5) idx = -1; 
        }
        if (target.general.name === 'èµµäº‘' && idx === -1) {
            idx = target.hand.indexOf(need === 'é—ª' ? 'æ€' : 'é—ª');
        }

        await sleep(500);
        if (idx !== -1) {
            target.hand.splice(idx, 1);
            log(`${target.general.name} æ‰“å‡ºã€${need}ã€‘`, "skill");
            SFX.card();
            await showEffect(target.id, need, "normal");
        } else {
            await damage(source, target);
        }
    }

    async function damage(source, target) {
        let dmg = 1;
        if (source.berserk) dmg++; // é…’/è£¸è¡£
        
        target.hp -= dmg;
        log(`${target.general.name} å—åˆ° ${dmg} ç‚¹ä¼¤å®³`, "damage");
        SFX.damage();
        await showEffect(target.id, `-${dmg} ä½“åŠ›`, "damage");
        
        // é“ç´¢è¿ç¯é€»è¾‘ (ç®€åŒ–ï¼šåªè¦å—ä¼¤å°±ä¼ å¯¼)
        if (target.chained) {
            target.chained = false; // é‡ç½®
            log("ã€é“ç´¢è¿ç¯ã€‘è§¦å‘ï¼", "skill");
            for (let p of players) {
                if (p !== target && p.chained && !p.isDead) {
                    p.chained = false;
                    await sleep(300);
                    await damage(source, p);
                }
            }
        }

        triggerDamageSkill(target);
        if (target.hp <= 0) {
            const tao = target.hand.indexOf('æ¡ƒ');
            if (tao !== -1) {
                target.hand.splice(tao, 1);
                target.hp++;
                log(`${target.general.name} æ¿’æ­»åƒæ¡ƒ`, "skill");
                SFX.heal();
                await showEffect(target.id, "æ¿’æ­»å›è¡€", "skill");
            } else handleDeath(source, target);
        }
        renderAll();
    }

    function triggerDamageSkill(p) {
        if (p.isDead) return;
        if (p.general.name === 'æ›¹æ“') { log(`ã€å¥¸é›„ã€‘æ‘¸1ç‰Œ`, "skill"); drawCards(p, 1); }
        if (p.general.name === 'éƒ­å˜‰') { log(`ã€é—è®¡ã€‘æ‘¸2ç‰Œ`, "skill"); drawCards(p, 2); }
    }

    function handleDeath(killer, dead) {
        dead.isDead = true; dead.identityKnown = true;
        log(`${dead.general.name} é˜µäº¡!`, "damage");
        
        if (dead.role === 'åè´¼') {
            log("å‡»æ€åè´¼ï¼Œæ‘¸3å¼ ç‰Œ", "system");
            drawCards(killer, 3);
        } else if (dead.role === 'å¿ è‡£' && killer.role === 'ä¸»å…¬') {
            log("ä¸»å…¬æ€å¿ è‡£ï¼Œå¼ƒå…‰æ‰‹ç‰Œ", "damage");
            killer.hand = [];
        }
        checkWin();
    }

    // --- AI é€»è¾‘ (Async) ---
    async function aiAction(ai) {
        if (ai.isDead || !gameActive) return;
        
        // 1. æ•‘å‘½/å¢ç›Š
        if (ai.hand.includes('æ— ä¸­')) await confirmUseCard(ai, ai.hand.indexOf('æ— ä¸­'), null);
        if (ai.hand.includes('äº”è°·')) await confirmUseCard(ai, ai.hand.indexOf('äº”è°·'), null);
        while (ai.hp < ai.maxHp && ai.hand.includes('æ¡ƒ')) await confirmUseCard(ai, ai.hand.indexOf('æ¡ƒ'), ai);
        if (ai.hand.includes('é…’') && ai.hp < ai.maxHp) await confirmUseCard(ai, ai.hand.indexOf('é…’'), ai);

        // 2. ç¡®å®šç›®æ ‡
        const alive = players.filter(p => !p.isDead && p !== ai);
        let target = null;
        if (ai.role === 'åè´¼') target = alive.find(p => p.role === 'ä¸»å…¬') || alive.find(p => p.identityKnown && p.role === 'å¿ è‡£');
        else if (ai.role === 'å¿ è‡£') target = alive.find(p => p.identityKnown && p.role === 'åè´¼');
        else if (ai.role === 'ä¸»å…¬') target = alive.find(p => p.identityKnown && (p.role === 'åè´¼' || p.role === 'å†…å¥¸'));
        if (!target) target = alive[Math.floor(Math.random()*alive.length)];

        // 3. æ”»å‡»
        if (target && !target.isDead) {
            if (ai.hand.includes('ä¹ä¸') && !target.lebu) await confirmUseCard(ai, ai.hand.indexOf('ä¹ä¸'), target);
            if (ai.hand.includes('é¡ºæ‰‹')) await confirmUseCard(ai, ai.hand.indexOf('é¡ºæ‰‹'), target);
            if (ai.hand.includes('æ‹†æ¡¥')) await confirmUseCard(ai, ai.hand.indexOf('æ‹†æ¡¥'), target);
            if (ai.hand.includes('å†³æ–—')) await confirmUseCard(ai, ai.hand.indexOf('å†³æ–—'), target);
            if (ai.hand.includes('æ€')) {
                if (!ai.hasAttacked || ai.general.name === 'å¼ é£') await confirmUseCard(ai, ai.hand.indexOf('æ€'), target);
            }
        }
        
        await sleep(500);
        nextTurn();
    }

    // --- è¾…åŠ© ---
    function drawCards(p, n) {
        for(let i=0; i<n; i++) {
            if (deck.length===0) { deck=[...DECK_TEMPLATE]; shuffle(deck); }
            p.hand.push(deck.pop());
        }
    }
    function shuffle(arr) { for(let i=arr.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    function log(msg, type="") {
        const box = document.getElementById('log-zone');
        const div = document.createElement('div');
        div.className = `log-line ${type==='turn'?'log-turn':(type==='damage'?'log-damage':(type==='skill'?'log-skill':(type==='system'?'log-system':'')))}`;
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
    function checkWin() {
        const lord = players.find(p => p.role === 'ä¸»å…¬');
        const rebels = players.filter(p => p.role === 'åè´¼' && !p.isDead);
        const traitor = players.filter(p => p.role === 'å†…å¥¸' && !p.isDead);
        if (lord.isDead) gameOver(false, "ä¸»å…¬é˜µäº¡ï¼Œéœ¸ä¸šæˆç©ºï¼");
        else if (rebels.length === 0 && traitor.length === 0) gameOver(true, "é€†è´¼å…¨ç­ï¼Œå¤©ä¸‹å¤§å®šï¼");
    }
    function gameOver(win, msg) {
        gameActive = false;
        document.getElementById('result-title').innerText = msg;
        document.getElementById('result-title').className = win ? 'win' : 'lose';
        document.getElementById('result-overlay').style.display = 'flex';
        win ? SFX.win() : SFX.lose();
        stopBGM();
    }
    function showHelp() { document.getElementById('help-overlay').style.display = 'flex'; }

    // --- æ¸²æŸ“ ---
    function renderAll() {
        const container = document.getElementById('enemy-zone');
        container.innerHTML = '';
        for(let i=1; i<=3; i++) {
            const p = players[i];
            const div = document.createElement('div');
            let roleText = p.identityKnown ? p.role : "???";
            let classes = `enemy-card ${p.isDead ? 'dead' : ''} ${currentTurnIndex === i ? 'active-turn' : ''}`;
            if (isTargetingMode && !p.isDead) classes += ' targetable';
            if (p.role === 'ä¸»å…¬') classes += ' lord-border';
            
            let statusHtml = '';
            if (p.lebu) statusHtml += '<span class="status-icon">ğŸ¤</span>';
            if (p.chained) statusHtml += '<span class="status-icon">â›“ï¸</span>';

            div.className = classes;
            div.onclick = () => selectTarget(i);
            div.innerHTML = `
                <div class="role-badge" style="background:${p.identityKnown?(p.role==='åè´¼'?'#2ecc71':(p.role==='å¿ è‡£'?'#e67e22':(p.role==='ä¸»å…¬'?'#f1c40f':'#9b59b6'))):'#333'}; color:${p.role==='ä¸»å…¬'?'#000':'#fff'}">${roleText}</div>
                <div class="avatar-frame" style="color:${p.general.color}">${p.general.avatar}</div>
                <div class="status-icons">${statusHtml}</div>
                <div class="info-block">
                    <div class="general-name">${p.general.name}</div>
                    <div class="hp-bar">${getHpHtml(p.hp, p.maxHp)}</div>
                    <div style="font-size:10px; color:#7f8c8d;">æ‰‹ç‰Œ: ${p.hand.length}</div>
                </div>
            `;
            container.appendChild(div);
        }
        document.getElementById('my-hp-bar').innerHTML = getHpHtml(players[0].hp, players[0].maxHp);
        let myStatus = '';
        if (players[0].lebu) myStatus += '<span class="status-icon">ğŸ¤</span>';
        if (players[0].chained) myStatus += '<span class="status-icon">â›“ï¸</span>';
        document.getElementById('my-status-icons').innerHTML = myStatus;
        updateHandUI();
    }
    function getHpHtml(hp, max) {
        let h = ''; for(let i=0; i<max; i++) h += `<div class="hp-point ${i<hp?'':'hp-lost'}"></div>`; return h;
    }
    function updateHandUI() {
        const c = document.getElementById('hand-scroll-container'); c.innerHTML = '';
        players[0].hand.forEach((card, i) => {
            const el = document.createElement('div');
            el.className = `card ${i===selectedCardIndex?'selected':''}`;
            el.setAttribute('data-type', card);
            el.onclick = () => selectCard(i);
            let icon = '';
            if(card==='æ€') icon='âš”ï¸'; if(card==='é—ª') icon='ğŸ’¨'; if(card==='æ¡ƒ') icon='ğŸ‘'; if(card==='é…’') icon='ğŸ¶';
            if(card==='ä¸‡ç®­') icon='ğŸ¹'; if(card==='å—è›®') icon='ğŸ˜'; if(card==='æ— ä¸­') icon='ğŸ';
            if(card==='é¡ºæ‰‹') icon='ğŸ”—'; if(card==='æ‹†æ¡¥') icon='ğŸª“';
            if(card==='å†³æ–—') icon='âš”ï¸'; if(card==='äº”è°·') icon='ğŸŒ¾'; if(card==='ç«æ”»') icon='ğŸ”¥';
            if(card==='ä¹ä¸') icon='ğŸ¤'; if(card==='é“ç´¢') icon='â›“ï¸';
            el.innerHTML = `<div class="card-icon">${icon}</div><div class="card-text">${card}</div>`;
            c.appendChild(el);
        });
    }
    function updateButtons() {
        const isMyTurn = currentTurnIndex === 0;
        const hasSel = selectedCardIndex !== -1;
        const card = hasSel ? players[0].hand[selectedCardIndex] : null;
        document.getElementById('btn-end').disabled = !isMyTurn;
        document.getElementById('btn-cancel').disabled = !hasSel;
        let can = false;
        if (isMyTurn && hasSel) {
            if (card === 'æ¡ƒ' && players[0].hp < players[0].maxHp) can = true;
            if (card === 'é…’') can = true;
            if (['ä¸‡ç®­', 'å—è›®', 'æ— ä¸­', 'äº”è°·'].includes(card)) can = true;
        }
        document.getElementById('btn-confirm').disabled = !can;
    }
    function endTurn() { if (currentTurnIndex === 0) nextTurn(); }

</script>
</body>
</html>
